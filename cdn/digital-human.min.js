!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("three"),require("three/addons/loaders/GLTFLoader.js"),require("three/addons/controls/OrbitControls.js")):"function"==typeof define&&define.amd?define(["exports","three","three/addons/loaders/GLTFLoader.js","three/addons/controls/OrbitControls.js"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).DigitalHuman={},e.THREE,e.THREE,e.THREE)}(this,function(e,t,i,n){"use strict";function s(e){var t=Object.create(null);return e&&Object.keys(e).forEach(function(i){if("default"!==i){var n=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(t,i,n.get?n:{enumerable:!0,get:function(){return e[i]}})}}),t.default=e,Object.freeze(t)}var o=s(t);const a={CDN_VERSION:"latest",get CDN_BASE(){return`https://cdn.jsdelivr.net/gh/zizaijiyihu/digital-human-component@${this.CDN_VERSION}/cdn`},DEFAULT_MODEL_URL:"https://models.readyplayer.me/690abee256dbb2e94779a60a.glb",get DEFAULT_ANIMATIONS(){return{idle:`${this.CDN_BASE}/animations/F_Standing_Idle_001.glb`,talking:`${this.CDN_BASE}/animations/F_Talking_Variations_005.glb`}},get DEFAULT_BACKGROUND_IMAGE(){return`${this.CDN_BASE}/images/office-background.jpg`},PHONEME_TO_VISEME:{aa:"viseme_aa",E:"viseme_E",I:"viseme_I",O:"viseme_O",U:"viseme_U",PP:"viseme_PP",FF:"viseme_FF",TH:"viseme_TH",DD:"viseme_DD",kk:"viseme_kk",CH:"viseme_CH",SS:"viseme_SS",nn:"viseme_nn",RR:"viseme_RR",sil:"viseme_sil"},CAMERA:{fov:45,aspect:1,near:.1,far:1e3,position:{x:0,y:1.6,z:.7},target:{x:0,y:1.5,z:0}},LIGHTS:{ambient:{color:16777215,intensity:1},key:{color:16777215,intensity:1.2,position:{x:0,y:2,z:1}},fill:{color:16777215,intensity:.6,position:{x:0,y:1.6,z:.8}},rim:{color:11193599,intensity:.4,position:{x:0,y:1.8,z:-.5}}},EXPRESSIONS:{blink:{duration:80,intensity:1},smile:{fadeIn:500,hold:{min:3e3,max:5e3},fadeOut:800,intensity:.35},nod:{duration:300,intensity:.1},browRaise:{duration:200,hold:400,intensity:.3},headTilt:{duration:600,hold:1500,intensity:.08}},EXPRESSION_FREQUENCY:{blink:{min:2e3,max:5e3},smile:{min:8e3,max:15e3},nod:{min:1e4,max:2e4},browRaise:{min:6e3,max:12e3},headTilt:{min:15e3,max:25e3}},LIP_SYNC:{fftSize:512,speechRate:3.5,syllableDuration:286,closeRatio:.2,decayRate:{normal:.85,silence:.5,closing:.3}}};class r{constructor(e,t={}){this.container=e,this.config=t,this.scene=null,this.camera=null,this.renderer=null,this.controls=null,this.mixer=null,this.clock=null,this.backgroundTexture=null,this.animationId=null,this.loadingElement=null,this._init()}_init(){this.scene=new o.Scene,this.scene.background=new o.Color(this.config.backgroundColor||"#1a1a2e");const e=this.config.width||this.container.clientWidth||600,t=this.config.height||this.container.clientHeight||600;console.log("ğŸ“ SceneManager initialized with size:",{width:e,height:t,aspectRatio:(e/t).toFixed(2),containerSize:`${this.container.clientWidth}x${this.container.clientHeight}`}),this.camera=new o.PerspectiveCamera(a.CAMERA.fov,e/t,a.CAMERA.near,a.CAMERA.far);const i=this.config.cameraPosition||a.CAMERA.position;if(this.camera.position.set(i.x,i.y,i.z),"static"===getComputedStyle(this.container).position&&(this.container.style.position="relative"),this.renderer=new o.WebGLRenderer({antialias:!0}),this.renderer.setSize(e,t),this.renderer.shadowMap.enabled=!0,this.renderer.domElement.style.opacity="0",this.renderer.domElement.style.transition="opacity 0.8s ease-in",this.renderer.domElement.style.display="block",this.container.appendChild(this.renderer.domElement),!0===this.config.enableOrbitControls){this.controls=new n.OrbitControls(this.camera,this.renderer.domElement);const e=this.config.cameraTarget||a.CAMERA.target;this.controls.target.set(e.x,e.y,e.z),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.minDistance=.5,this.controls.maxDistance=1.5,this.controls.update()}this._setupLights(),this.clock=new o.Clock,this._startRenderLoop(),window.addEventListener("resize",()=>this._onWindowResize())}_setupLights(){const e=a.LIGHTS,t=new o.AmbientLight(e.ambient.color,e.ambient.intensity);this.scene.add(t);const i=new o.DirectionalLight(e.key.color,e.key.intensity);i.position.set(e.key.position.x,e.key.position.y,e.key.position.z),this.scene.add(i);const n=new o.DirectionalLight(e.fill.color,e.fill.intensity);n.position.set(e.fill.position.x,e.fill.position.y,e.fill.position.z),this.scene.add(n);const s=new o.DirectionalLight(e.rim.color,e.rim.intensity);s.position.set(e.rim.position.x,e.rim.position.y,e.rim.position.z),this.scene.add(s)}_startRenderLoop(){const e=()=>{this.animationId=requestAnimationFrame(e);const t=this.clock.getDelta();this.mixer&&this.mixer.update(t),this.controls&&this.controls.update(),this.renderer.render(this.scene,this.camera)};e()}_onWindowResize(){const e=this.container.clientWidth,t=this.container.clientHeight;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}setBackgroundColor(e){this.scene.background=new o.Color(e)}async setBackgroundImage(e){return new Promise((t,i)=>{(new o.TextureLoader).load(e,e=>{this.backgroundTexture&&this.backgroundTexture.dispose();const i=e.image.width/e.image.height;if(i>1){const t=1/i;e.repeat.set(t,1),e.offset.set((1-t)/2,0)}else{const t=i/1;e.repeat.set(1,t),e.offset.set(0,(1-t)/2)}this.scene.background=e,this.backgroundTexture=e,t()},void 0,i)})}clearBackgroundImage(){this.backgroundTexture&&(this.backgroundTexture.dispose(),this.backgroundTexture=null),this.scene.background=new o.Color(this.config.backgroundColor||"#1a1a2e")}showLoading(){if(this.loadingElement)return;this.loadingElement=document.createElement("div"),this.loadingElement.style.cssText="\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            align-items: center;\n            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);\n            z-index: 1000;\n        ";const e=document.createElement("div");e.style.cssText="\n            width: 120px;\n            height: 120px;\n            border-radius: 50%;\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            margin-bottom: 30px;\n            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);\n            position: relative;\n        ";const t=document.createElement("div");t.innerHTML='\n            <svg width="60" height="60" viewBox="0 0 24 24" fill="none">\n                <path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z" fill="white"/>\n            </svg>\n        ',e.appendChild(t);const i=document.createElement("div");i.style.cssText="\n            position: absolute;\n            width: 140px;\n            height: 140px;\n            border: 3px solid rgba(102, 126, 234, 0.6);\n            border-radius: 50%;\n            animation: pulse 1.5s ease-out infinite;\n        ",e.appendChild(i);const n=document.createElement("div");n.textContent="æ­£åœ¨è¿æ¥é€šè¯...",n.style.cssText='\n            color: #2d3748;\n            font-size: 18px;\n            font-weight: 500;\n            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n            margin-bottom: 10px;\n        ';const s=document.createElement("div");s.textContent="è¯·ç¨å€™...",s.style.cssText='\n            color: #718096;\n            font-size: 14px;\n            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n        ';const o=document.createElement("style");o.textContent="\n            @keyframes pulse {\n                0% {\n                    transform: scale(1);\n                    opacity: 1;\n                }\n                100% {\n                    transform: scale(1.3);\n                    opacity: 0;\n                }\n            }\n        ",document.head.appendChild(o),this.loadingElement.appendChild(e),this.loadingElement.appendChild(n),this.loadingElement.appendChild(s),this.container.appendChild(this.loadingElement)}hideLoading(){this.loadingElement&&(this.loadingElement.style.transition="opacity 0.5s ease",this.loadingElement.style.opacity="0",setTimeout(()=>{this.loadingElement&&this.loadingElement.parentNode&&(this.loadingElement.parentNode.removeChild(this.loadingElement),this.loadingElement=null)},500)),this.showScene()}showScene(){this.renderer&&this.renderer.domElement&&requestAnimationFrame(()=>{this.renderer.domElement.style.opacity="1"})}destroy(){this.animationId&&cancelAnimationFrame(this.animationId),this.backgroundTexture&&this.backgroundTexture.dispose(),this.renderer&&(this.renderer.dispose(),this.renderer.domElement.parentNode&&this.renderer.domElement.parentNode.removeChild(this.renderer.domElement)),this.controls&&this.controls.dispose(),window.removeEventListener("resize",this._onWindowResize)}}class h{constructor(e,t){this.avatar=e,this.mixer=t||new o.AnimationMixer(e),this.animations=new Map,this.currentAction=null,this.loader=new i.GLTFLoader}async loadAnimation(e,t){return console.log(`ğŸ“¥ Loading animation "${e}" from:`,t),new Promise((i,n)=>{this.loader.load(t,s=>{if(s.animations&&s.animations.length>0){const t=s.animations[0],n=this.mixer.clipAction(t);n.setLoop(o.LoopRepeat),this.animations.set(e,{clip:t,action:n}),console.log(`âœ… Animation "${e}" loaded successfully (duration: ${t.duration.toFixed(2)}s)`),i({name:e,clip:t,action:n})}else n(new Error(`No animations found in ${t}`))},t=>{const i=(t.loaded/t.total*100).toFixed(0);console.log(`â³ Loading "${e}": ${i}%`)},t=>{console.error(`âŒ Failed to load animation "${e}":`,t),n(t)})})}play(e,t=.3){const i=this.animations.get(e);if(!i)return console.warn(`âŒ Animation "${e}" not loaded`),void console.log("Available animations:",Array.from(this.animations.keys()));const{action:n}=i;this.currentAction&&this.currentAction!==n&&(console.log("â¸ï¸ Fading out previous animation"),this.currentAction.fadeOut(t)),n.reset(),n.fadeIn(t),n.play(),this.currentAction=n,console.log(`â–¶ï¸ Playing animation "${e}" (weight: ${n.getEffectiveWeight()})`)}stop(e=null,t=.3){if(e){const i=this.animations.get(e);i&&i.action.fadeOut(t)}else this.currentAction&&(this.currentAction.fadeOut(t),this.currentAction=null)}stopAll(){this.animations.forEach(({action:e})=>{e.stop()}),this.currentAction=null}destroy(){this.stopAll(),this.animations.clear()}}class l{constructor(e){if(!e)throw new Error("LipSyncEngine: morphTargetMesh is required");this.morphTargetMesh=e,this.morphTargetDict=e.morphTargetDictionary,this.audioContext=null,this.analyser=null,this.audioSource=null,this.isActive=!1,this.isClosing=!1,this.animationId=null,this.currentPhoneme="sil",this.currentViseme="viseme_sil",this.lastPhonemeTime=0,this.isStreamingMode=!1,this.externalAnalyser=null,this.streamStartTime=0,this.config=a.LIP_SYNC,this.phonemeMap=a.PHONEME_TO_VISEME}start(e){if(this.morphTargetMesh){if(this.audioContext&&"closed"!==this.audioContext.state||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=this.config.fftSize,this.analyser.connect(this.audioContext.destination)),"suspended"===this.audioContext.state&&this.audioContext.resume(),this.audioSource)try{this.audioSource.disconnect()}catch(e){}try{this.audioSource=this.audioContext.createMediaElementSource(e),this.audioSource.connect(this.analyser)}catch(e){return void console.error("Failed to create audio source:",e)}this.isActive=!0,this.isClosing=!1,this.isStreamingMode=!1,this.currentPhoneme="sil",this.currentViseme="viseme_sil",this.lastPhonemeTime=Date.now(),this._update(e)}else console.error("âŒ morphTargetMesh not initialized")}startStreaming(e,t){this.morphTargetMesh?e&&t?(this.externalAnalyser=e,this.audioContext=t,this.analyser=e,this.isActive=!0,this.isClosing=!1,this.isStreamingMode=!0,this.currentPhoneme="sil",this.currentViseme="viseme_sil",this.lastPhonemeTime=Date.now(),this.streamStartTime=Date.now(),this._updateStreaming()):console.error("âŒ analyser and audioContext are required for streaming mode"):console.error("âŒ morphTargetMesh not initialized")}stop(){(this.isActive||this.isClosing)&&(this.isActive=!1,this.isClosing=!0,this.isStreamingMode&&(this.externalAnalyser=null))}_updateStreaming(){if(!this.isActive&&!this.isClosing)return;if(this.isClosing){if(this._closeVisemes(),!this.isClosing)return;return void requestAnimationFrame(()=>this._updateStreaming())}requestAnimationFrame(()=>this._updateStreaming());const e=new Uint8Array(this.analyser.frequencyBinCount);this.analyser.getByteFrequencyData(e);const t=(Date.now()-this.streamStartTime)/1e3;this._analyzeAndUpdateVisemes(e,t)}_update(e){if(!this.isActive&&!this.isClosing)return;if(this.isClosing){if(this._closeVisemes(),!this.isClosing)return;return void requestAnimationFrame(()=>this._update(e))}if(e.ended||e.currentTime>=e.duration-.05)return this.isActive=!1,this.isClosing=!0,void requestAnimationFrame(()=>this._update(e));requestAnimationFrame(()=>this._update(e));const t=new Uint8Array(this.analyser.frequencyBinCount);this.analyser.getByteFrequencyData(t),this._analyzeAndUpdateVisemes(t,e.currentTime)}_closeVisemes(){let e=!0;Object.values(this.phonemeMap).forEach(t=>{const i=this.morphTargetDict[t];if(void 0!==i){const t=this.morphTargetMesh.morphTargetInfluences[i]||0;t>.001?(this.morphTargetMesh.morphTargetInfluences[i]=t*this.config.decayRate.closing,e=!1):this.morphTargetMesh.morphTargetInfluences[i]=0}});const t=this.morphTargetDict.jawOpen;if(void 0!==t){const i=this.morphTargetMesh.morphTargetInfluences[t]||0;i>.001?(this.morphTargetMesh.morphTargetInfluences[t]=i*this.config.decayRate.closing,e=!1):this.morphTargetMesh.morphTargetInfluences[t]=0}e&&(this.isClosing=!1)}_analyzeAndUpdateVisemes(e,t){let i=0,n=0,s=0,o=0,a=0;for(let t=0;t<15;t++)i+=e[t];for(let t=15;t<35;t++)n+=e[t];for(let t=35;t<70;t++)s+=e[t];for(let t=70;t<120;t++)o+=e[t];for(let t=120;t<180;t++)a+=e[t];i/=3825,n/=5100,s/=8925,o/=12750,a/=15300;const r=(i+n+s+o+a)/5;let h="sil",l="viseme_sil";1e3*t%this.config.syllableDuration/this.config.syllableDuration>1-this.config.closeRatio||r<.05?(h="sil",l="viseme_sil"):o>.25&&o/(n+i+.001)>1.5?(h="SS",l="viseme_SS"):a>.2?(h="kk",l="viseme_kk"):s>.25&&o>.15?(h="CH",l="viseme_SS"):s>.3?(h="DD",l="viseme_DD"):i>n&&i>.2?(h=i>.35?"aa":"O",l="aa"===h?"viseme_aa":"viseme_O"):n>.2?(h=n>1.3*s?"E":"I",l="E"===h?"viseme_E":"viseme_I"):(h="aa",l="viseme_aa");const d=Date.now();h!==this.currentPhoneme&&d-this.lastPhonemeTime>80&&(this.currentPhoneme=h,this.currentViseme=l,this.lastPhonemeTime=d);const c=this.morphTargetDict[this.currentViseme];if(void 0!==c){const e=this.morphTargetMesh.morphTargetInfluences[c]||0,t=Math.min(1.2*r,.7);this.morphTargetMesh.morphTargetInfluences[c]=.7*e+.3*t}const u="sil"===this.currentPhoneme?this.config.decayRate.silence:this.config.decayRate.normal;Object.values(this.phonemeMap).forEach(e=>{if(e!==this.currentViseme){const t=this.morphTargetDict[e];void 0!==t&&(this.morphTargetMesh.morphTargetInfluences[t]*=u)}});const p=this.morphTargetDict.jawOpen;if(void 0!==p)if("sil"===this.currentPhoneme){const e=this.morphTargetMesh.morphTargetInfluences[p]||0;this.morphTargetMesh.morphTargetInfluences[p]=.4*e}else{let e=0;["aa","E","O","I","U"].includes(this.currentPhoneme)?e=.5*r:["DD","nn","CH","SS"].includes(this.currentPhoneme)&&(e=.2*r);const t=this.morphTargetMesh.morphTargetInfluences[p]||0;this.morphTargetMesh.morphTargetInfluences[p]=.7*t+.3*e}}destroy(){this.stop(),this.audioSource&&(this.audioSource.disconnect(),this.audioSource=null),this.audioContext&&(this.audioContext.close(),this.audioContext=null)}}class d{constructor(e,t,i,n={}){this.morphTargetMesh=e,this.morphTargetDict=e?e.morphTargetDictionary:{},this.headBone=t,this.neckBone=i,this.config=n,this.mode=null,this.intervals=[]}startListeningMode(){this.stopAll(),this.mode="listening";const e=this.config.expressionFrequency||a.EXPRESSION_FREQUENCY;!1!==this.config.enableBlinking&&this._scheduleExpression("blink",e.blink.min,e.blink.max),!1!==this.config.enableSmiling&&this._scheduleExpression("smile",e.smile.min,e.smile.max),!1!==this.config.enableNodding&&this._scheduleExpression("nod",e.nod.min,e.nod.max),!1!==this.config.enableBrowRaising&&this._scheduleExpression("raiseBrows",e.browRaise.min,e.browRaise.max),!1!==this.config.enableHeadTilting&&this._scheduleExpression("tiltHead",e.headTilt.min,e.headTilt.max)}stopListeningMode(){"listening"===this.mode&&this.stopAll()}startSpeakingMode(){if(this.stopAll(),this.mode="speaking",!1!==this.config.enableBlinking){const e=this.config.expressionFrequency||a.EXPRESSION_FREQUENCY;this._scheduleExpression("blink",e.blink.min+500,e.blink.max+500)}}stopSpeakingMode(){"speaking"===this.mode&&this.stopAll()}stopAll(){this.intervals.forEach(e=>clearInterval(e)),this.intervals=[],this.mode=null}_scheduleExpression(e,t,i){const n=()=>{this[e]&&this[e]();const s=Math.random()*(i-t)+t,o=setTimeout(n,s);this.intervals.push(o)},s=Math.random()*(i-t)+t,o=setTimeout(n,s);this.intervals.push(o)}blink(){if(!this.morphTargetMesh)return;const e=this.morphTargetDict,t=this.morphTargetMesh.morphTargetInfluences,i=e.eyeBlinkLeft,n=e.eyeBlinkRight;if(void 0===i||void 0===n)return;const s=a.EXPRESSIONS.blink,o=s.duration;this._tween({value:0},{value:s.intensity},o,e=>{t[i]=e.value,t[n]=e.value},()=>{this._tween({value:s.intensity},{value:0},o,e=>{t[i]=e.value,t[n]=e.value})})}smile(){if(!this.morphTargetMesh)return;const e=this.morphTargetDict,t=this.morphTargetMesh.morphTargetInfluences,i=e.mouthSmileLeft,n=e.mouthSmileRight;if(void 0===i||void 0===n)return;const s=a.EXPRESSIONS.smile;this._tween({value:0},{value:s.intensity},s.fadeIn,e=>{t[i]=e.value,t[n]=e.value},()=>{const e=Math.random()*(s.hold.max-s.hold.min)+s.hold.min;setTimeout(()=>{this._tween({value:s.intensity},{value:0},s.fadeOut,e=>{t[i]=e.value,t[n]=e.value})},e)})}nod(){if(!this.headBone)return;const e=this.headBone.rotation.x,t=a.EXPRESSIONS.nod;this._tween({x:e},{x:e+t.intensity},t.duration,e=>{this.headBone.rotation.x=e.x},()=>{this._tween({x:e+t.intensity},{x:e},t.duration,e=>{this.headBone.rotation.x=e.x})})}raiseBrows(){if(!this.morphTargetMesh)return;const e=this.morphTargetDict,t=this.morphTargetMesh.morphTargetInfluences,i=e.browInnerUp;if(void 0===i)return;const n=a.EXPRESSIONS.browRaise;this._tween({value:0},{value:n.intensity},n.duration,e=>{t[i]=e.value},()=>{this._tween({value:n.intensity},{value:0},n.hold,e=>{t[i]=e.value})})}tiltHead(){if(!this.headBone)return;const e=this.headBone.rotation.z,t=Math.random()>.5?1:-1,i=a.EXPRESSIONS.headTilt;this._tween({z:e},{z:e+i.intensity*t},i.duration,e=>{this.headBone.rotation.z=e.z},()=>{setTimeout(()=>{this._tween({z:e+i.intensity*t},{z:e},i.duration,e=>{this.headBone.rotation.z=e.z})},i.hold)})}_tween(e,t,i,n,s){const o=Date.now(),a=Object.keys(t),r=()=>{const h=Date.now()-o,l=Math.min(h/i,1),d=l<.5?2*l*l:1-Math.pow(-2*l+2,2)/2;a.forEach(i=>{e[i]=e[i]+(t[i]-e[i])*d}),n(e),l<1?requestAnimationFrame(r):s&&s()};r()}destroy(){this.stopAll()}}class c{constructor(){this._events={}}on(e,t){return this._events[e]||(this._events[e]=[]),this._events[e].push(t),this}once(e,t){const i=(...n)=>{t(...n),this.off(e,i)};return this.on(e,i)}off(e,t){return this._events[e]?t?(this._events[e]=this._events[e].filter(e=>e!==t),this):(delete this._events[e],this):this}emit(e,...t){return this._events[e]?(this._events[e].forEach(e=>{e(...t)}),this):this}removeAllListeners(e){return e?delete this._events[e]:this._events={},this}}function u(e,t={}){const{sampleRate:i=16e3,numChannels:n=1,bitDepth:s=16}=t,o=e instanceof Uint8Array?e:new Uint8Array(e),a=s/8;o.length;const r=new ArrayBuffer(44+o.length),h=new DataView(r);p(h,0,"RIFF"),h.setUint32(4,36+o.length,!0),p(h,8,"WAVE"),p(h,12,"fmt "),h.setUint32(16,16,!0),h.setUint16(20,1,!0),h.setUint16(22,n,!0),h.setUint32(24,i,!0),h.setUint32(28,i*n*a,!0),h.setUint16(32,n*a,!0),h.setUint16(34,s,!0),p(h,36,"data"),h.setUint32(40,o.length,!0);return new Uint8Array(r).set(o,44),r}function p(e,t,i){for(let n=0;n<i.length;n++)e.setUint8(t+n,i.charCodeAt(n))}function m(e){if(e.byteLength<12)return!1;const t=new DataView(e);return"RIFF"!==String.fromCharCode(t.getUint8(0),t.getUint8(1),t.getUint8(2),t.getUint8(3))}function g(e,t={}){return m(e)?(console.log("ğŸ”„ æ£€æµ‹åˆ° PCM æ ¼å¼ï¼Œè‡ªåŠ¨è½¬æ¢ä¸º WAV"),u(e,t)):e}class f{constructor(e,t,i={}){this.audioContext=e,this.analyser=t,this.queue=[],this.isPlaying=!1,this.isStopped=!1,this.nextStartTime=0,this.activeSources=[],this.onStart=null,this.onEnd=null,this.onError=null,this.config={bufferThreshold:.5,maxQueueDuration:10,autoPCMConvert:!1!==i.autoPCMConvert,pcmOptions:{sampleRate:i.sampleRate||16e3,numChannels:i.numChannels||1,bitDepth:i.bitDepth||16}},this.onNeedData=null}async enqueue(e){if(!this.isStopped)try{let t=e;this.config.autoPCMConvert&&(t=g(e,this.config.pcmOptions));const i=await this.audioContext.decodeAudioData(t);if(this._getQueueDuration()>this.config.maxQueueDuration)return void console.warn("AudioStreamQueue: Queue is full, skipping chunk");this.queue.push(i),this.isPlaying?this._scheduleNext():this._startPlayback()}catch(e){console.error("AudioStreamQueue: Failed to decode audio data:",e),this.onError&&this.onError(e)}}finalize(){this.isFinalized=!0}stop(){this.isStopped=!0,this.isPlaying=!1,this.activeSources.forEach(e=>{try{e.stop()}catch(e){}}),this.activeSources=[],this.queue=[],this.nextStartTime=0}_getQueueDuration(){return this.queue.reduce((e,t)=>e+t.duration,0)}_startPlayback(){this.isPlaying||0===this.queue.length||(this.isPlaying=!0,this.nextStartTime=this.audioContext.currentTime,this.onStart&&this.onStart(),this._playNext())}_playNext(){if(this.isStopped||0===this.queue.length)return void(this.isFinalized&&0===this.queue.length&&0===this.activeSources.length&&(this.isPlaying=!1,this.onEnd&&this.onEnd()));const e=this.queue.shift(),t=this.audioContext.createBufferSource();t.buffer=e,t.connect(this.analyser),t.onended=()=>{const e=this.activeSources.indexOf(t);e>-1&&this.activeSources.splice(e,1);this._getQueueDuration()<this.config.bufferThreshold&&this.onNeedData&&!this.isFinalized&&this.onNeedData(),this.isFinalized&&0===this.queue.length&&0===this.activeSources.length&&(this.isPlaying=!1,this.onEnd&&this.onEnd())};const i=Math.max(this.nextStartTime,this.audioContext.currentTime);t.start(i),this.activeSources.push(t),this.nextStartTime=i+e.duration,this.queue.length>0&&this._playNext()}_scheduleNext(){this.queue.length>0&&this._playNext()}destroy(){this.stop(),this.onStart=null,this.onEnd=null,this.onError=null,this.onNeedData=null}}class C{constructor(e,t={}){this.analyser=e,this.baseThreshold=t.threshold||30,this.silenceDuration=t.silenceDuration||2e3,this.minSpeakDuration=t.minSpeakDuration||500,this.calibrationDuration=t.calibrationDuration||3e3,this.noiseUpdateInterval=t.noiseUpdateInterval||1e4,this.noiseBaseline=null,this.noiseHistory=[],this.lowThresholdMultiplier=1.5,this.highThresholdMultiplier=3,this.isCalibrated=!1,this.lastNoiseUpdateTime=0,this.state="IDLE",this.preActiveStartTime=0,this.speechStartTime=0,this.silenceStartTime=0,this.lastSpeechTime=0,this.energyTrend=[],this.energyTrendWindow=5,this.onSpeakingStart=null,this.onSpeakingEnd=null,this.onCalibrationComplete=null,this.detectionInterval=null,this.isRunning=!1,this.dataArray=new Uint8Array(e.frequencyBinCount),this.lastLogTime=0}start(e=100){this.isRunning||(this.isRunning=!0,this.state="IDLE",this.preActiveStartTime=0,this.speechStartTime=0,this.silenceStartTime=0,this.lastSpeechTime=0,this.energyTrend=[],this.noiseHistory=[],this.isCalibrated=!1,this.noiseBaseline=null,console.log("ğŸ™ï¸ SpeechDetector å¯åŠ¨ä¸­..."),console.log(`   - æ ¡å‡†æ—¶é•¿: ${this.calibrationDuration}ms`),console.log(`   - æ£€æµ‹é—´éš”: ${e}ms`),this._startCalibration(e),this.detectionInterval=setInterval(()=>{this._detect()},e),this.isRunning=!0)}_startCalibration(e){console.log("ğŸ“Š å¼€å§‹æ ¡å‡†èƒŒæ™¯å™ªéŸ³...");const t=Date.now(),i=setInterval(()=>{const e=this._getAudioEnergy();this.noiseHistory.push(e);Date.now()-t>=this.calibrationDuration&&(clearInterval(i),this._completeCalibration())},e)}_completeCalibration(){if(0===this.noiseHistory.length)return console.warn("âš ï¸ æ ¡å‡†å¤±è´¥ï¼šæ— æœ‰æ•ˆæ•°æ®ï¼Œä½¿ç”¨é»˜è®¤é˜ˆå€¼"),this.noiseBaseline=this.baseThreshold/this.highThresholdMultiplier,void(this.isCalibrated=!0);this.noiseBaseline=this._median(this.noiseHistory),this.isCalibrated=!0,this.lastNoiseUpdateTime=Date.now();const e=this.getLowThreshold(),t=this.getHighThreshold();console.log("âœ… æ ¡å‡†å®Œæˆï¼"),console.log(`   - èƒŒæ™¯å™ªéŸ³åŸºå‡†: ${this.noiseBaseline.toFixed(1)}`),console.log(`   - é¢„æ¿€æ´»é˜ˆå€¼: ${e.toFixed(1)} (åŸºå‡† Ã— ${this.lowThresholdMultiplier})`),console.log(`   - ç¡®è®¤é˜ˆå€¼: ${t.toFixed(1)} (åŸºå‡† Ã— ${this.highThresholdMultiplier})`),this.onCalibrationComplete&&this.onCalibrationComplete({noiseBaseline:this.noiseBaseline,lowThreshold:e,highThreshold:t})}stop(){this.isRunning&&(this.isRunning=!1,this.detectionInterval&&(clearInterval(this.detectionInterval),this.detectionInterval=null),"SPEAKING"===this.state&&this.onSpeakingEnd&&this.onSpeakingEnd(),this.state="IDLE",console.log("â¹ SpeechDetector stopped"))}_detect(){if(!this.isCalibrated)return;const e=Date.now(),t=this._getAudioEnergy(),i=this.getLowThreshold(),n=this.getHighThreshold();if(this.energyTrend.push(t),this.energyTrend.length>this.energyTrendWindow&&this.energyTrend.shift(),e-this.lastLogTime>1e3){const s={IDLE:"âšª",PRE_ACTIVE:"ğŸŸ¡",SPEAKING:"ğŸŸ¢"};console.log(`[VAD] èƒ½é‡: ${t.toFixed(1)} | é˜ˆå€¼: [${i.toFixed(1)}, ${n.toFixed(1)}] | çŠ¶æ€: ${s[this.state]} ${this.state}`),this.lastLogTime=e}switch(this.state){case"IDLE":this._handleIdleState(t,i,e);break;case"PRE_ACTIVE":this._handlePreActiveState(t,i,n,e);break;case"SPEAKING":this._handleSpeakingState(t,i,e)}"IDLE"===this.state&&e-this.lastNoiseUpdateTime>this.noiseUpdateInterval&&this._updateNoiseBaseline(t)}_handleIdleState(e,t,i){e>t&&(this.state="PRE_ACTIVE",this.preActiveStartTime=i,this.energyTrend=[e],console.log(`[VAD] ğŸŸ¡ è¿›å…¥é¢„æ¿€æ´»çŠ¶æ€ (èƒ½é‡: ${e.toFixed(1)} > ${t.toFixed(1)})`))}_handlePreActiveState(e,t,i,n){const s=n-this.preActiveStartTime,o=this._isEnergyRising();o&&s>=300||e>i?(this.state="SPEAKING",this.speechStartTime=this.preActiveStartTime,this.silenceStartTime=0,this.lastSpeechTime=n,console.log(`[VAD] ğŸŸ¢ ç¡®è®¤è¯´è¯å¼€å§‹ï¼(${o?"èƒ½é‡æŒç»­ä¸Šå‡":"è¶…è¿‡é«˜é˜ˆå€¼"}, æŒç»­ ${s}ms)`),this.onSpeakingStart&&this.onSpeakingStart()):e<t&&s>500&&(this.state="IDLE",this.preActiveStartTime=0,console.log("[VAD] âšª é¢„æ¿€æ´»å–æ¶ˆ (èƒ½é‡å›è½)"))}_handleSpeakingState(e,t,i){if(e>t)this.lastSpeechTime=i,this.silenceStartTime=0;else{0===this.silenceStartTime&&(this.silenceStartTime=i,console.log(`[VAD] ğŸ”‡ æ£€æµ‹åˆ°é™éŸ³ï¼Œç­‰å¾…æŒç»­ ${this.silenceDuration}ms...`));const e=i-this.silenceStartTime;if(e>=this.silenceDuration){const t=this.lastSpeechTime-this.speechStartTime;this.state="IDLE",this.speechStartTime=0,this.silenceStartTime=0,this.preActiveStartTime=0,console.log(`[VAD] â¹ï¸ è¯´è¯ç»“æŸï¼æ€»æ—¶é•¿: ${(t/1e3).toFixed(1)}s, é™éŸ³: ${e}ms`),this.onSpeakingEnd&&this.onSpeakingEnd()}}}_isEnergyRising(){if(this.energyTrend.length<3)return!1;return this._average(this.energyTrend.slice(-2))>1.2*this._average(this.energyTrend.slice(0,2))}_updateNoiseBaseline(e){this.noiseHistory.push(e),this.noiseHistory.length>30&&this.noiseHistory.shift();const t=this._median(this.noiseHistory);this.noiseBaseline=.8*this.noiseBaseline+.2*t,this.lastNoiseUpdateTime=Date.now(),console.log(`[VAD] ğŸ“Š å™ªéŸ³åŸºå‡†å·²æ›´æ–°: ${this.noiseBaseline.toFixed(1)}`)}getLowThreshold(){return this.isCalibrated&&null!==this.noiseBaseline?this.noiseBaseline*this.lowThresholdMultiplier:.5*this.baseThreshold}getHighThreshold(){return this.isCalibrated&&null!==this.noiseBaseline?this.noiseBaseline*this.highThresholdMultiplier:this.baseThreshold}_getAudioEnergy(){this.analyser.getByteFrequencyData(this.dataArray);let e=0;for(let t=0;t<this.dataArray.length;t++)e+=this.dataArray[t];return e/this.dataArray.length}_median(e){if(0===e.length)return 0;const t=[...e].sort((e,t)=>e-t),i=Math.floor(t.length/2);return t.length%2==0?(t[i-1]+t[i])/2:t[i]}_average(e){return 0===e.length?0:e.reduce((e,t)=>e+t,0)/e.length}getSpeakingState(){return"SPEAKING"===this.state}getCurrentEnergy(){return this._getAudioEnergy()}getCurrentState(){return this.state}getNoiseBaseline(){return this.noiseBaseline}setNoiseBaseline(e){this.noiseBaseline=e,this.isCalibrated=!0,console.log(`[VAD] æ‰‹åŠ¨è®¾ç½®å™ªéŸ³åŸºå‡†: ${e.toFixed(1)}`)}setThresholdMultipliers(e,t){this.lowThresholdMultiplier=e,this.highThresholdMultiplier=t,console.log(`[VAD] é˜ˆå€¼å€æ•°å·²æ›´æ–°: ä½=${e}, é«˜=${t}`)}destroy(){this.stop(),this.onSpeakingStart=null,this.onSpeakingEnd=null,this.onCalibrationComplete=null,this.dataArray=null,this.noiseHistory=[],this.energyTrend=[]}}class y{constructor(e=1){this.maxGroups=e,this.videoGroups=[],this.currentChunks=[],this.currentStartTime=null}startNewGroup(e){this.currentChunks.length>0&&this._finishCurrentGroup(e),this.currentChunks=[],this.currentStartTime=e,console.log(`[CircularBuffer] Started new group #${this.videoGroups.length+1} at ${e}`)}add(e){this.currentStartTime?this.currentChunks.push(e):console.warn("[CircularBuffer] No current group, call startNewGroup first")}_finishCurrentGroup(e){if(0===this.currentChunks.length)return;const t=e-this.currentStartTime,i=new Blob(this.currentChunks,{type:"video/webm"}),n={blob:i,startTime:this.currentStartTime,endTime:e,duration:t,size:i.size,chunkCount:this.currentChunks.length};if(this.videoGroups.push(n),console.log(`[CircularBuffer] Group #${this.videoGroups.length} completed: ${(t/1e3).toFixed(1)}s, ${(i.size/1024/1024).toFixed(2)} MB, ${this.currentChunks.length} chunks`),this.videoGroups.length>this.maxGroups){const e=this.videoGroups.shift();console.log(`[CircularBuffer] Removed old group: ${(e.duration/1e3).toFixed(1)}s, ${(e.size/1024/1024).toFixed(2)} MB`)}this.currentChunks=[],this.currentStartTime=null}getAllGroups(){return[...this.videoGroups]}getCurrentGroup(){if(0===this.currentChunks.length)return null;const e=new Blob(this.currentChunks,{type:"video/webm"}),t=Date.now()-this.currentStartTime;return{blob:e,startTime:this.currentStartTime,endTime:Date.now(),duration:t,size:e.size,chunkCount:this.currentChunks.length,isRecording:!0}}getGroupCount(){return this.videoGroups.length}isEmpty(){return 0===this.videoGroups.length&&0===this.currentChunks.length}clear(){this.videoGroups=[],this.currentChunks=[],this.currentStartTime=null,console.log("[CircularBuffer] Cleared all groups")}}class S{constructor(e,t={}){this.mediaStream=e,this.config={maxGroups:t.maxGroups||1,groupDuration:t.groupDuration||5e3,speechThreshold:t.speechThreshold||40,silenceDuration:t.silenceDuration||2e3,minSpeakDuration:t.minSpeakDuration||500,maxRecordDuration:t.maxRecordDuration||3e5,videoFormat:t.videoFormat||"video/webm",videoBitsPerSecond:t.videoBitsPerSecond||25e5},this.onVideoCapture=t.onVideoCapture||null,this.onSpeakingStart=t.onSpeakingStart||null,this.onSpeakingEnd=t.onSpeakingEnd||null,this.onError=t.onError||null,this.isRunning=!1,this.isRecording=!1,this.circularBuffer=null,this.mediaRecorder=null,this.speechDetector=null,this.audioContext=null,this.audioAnalyser=null,this.restartTimer=null,this.speakingRecorder=null,this.speakingChunks=[],this.speakingStartTime=null,this.speakingTimeout=null,this.snapshotGroups=null}async start(){if(this.isRunning)console.warn("VideoAutoCaptureManager already running");else try{this.circularBuffer=new y(this.config.maxGroups),this._initAudioAnalyser(),this._initSpeechDetector(),this._initMediaRecorder(),this._startRecording(),this.isRunning=!0,console.log(`âœ… VideoAutoCaptureManager started (${this.config.maxGroups} groups Ã— ${this.config.groupDuration}ms)`)}catch(e){throw console.error("Failed to start VideoAutoCaptureManager:",e),this.onError&&this.onError(e),e}}stop(){this.isRunning&&(this.restartTimer&&(clearInterval(this.restartTimer),this.restartTimer=null),this.speechDetector&&this.speechDetector.stop(),this.mediaRecorder&&"recording"===this.mediaRecorder.state&&this.mediaRecorder.stop(),this.speakingRecorder&&"recording"===this.speakingRecorder.state&&this.speakingRecorder.stop(),this.circularBuffer&&this.circularBuffer.clear(),this.isRunning=!1,this.isRecording=!1,console.log("â¹ VideoAutoCaptureManager stopped"))}_initAudioAnalyser(){this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioAnalyser=this.audioContext.createAnalyser(),this.audioAnalyser.fftSize=2048,this.audioAnalyser.smoothingTimeConstant=.8;this.audioContext.createMediaStreamSource(this.mediaStream).connect(this.audioAnalyser)}_initSpeechDetector(){this.speechDetector=new C(this.audioAnalyser,{threshold:this.config.speechThreshold,silenceDuration:this.config.silenceDuration,minSpeakDuration:this.config.minSpeakDuration}),this.speechDetector.onSpeakingStart=()=>{this._handleSpeakingStart()},this.speechDetector.onSpeakingEnd=()=>{this._handleSpeakingEnd()}}_initMediaRecorder(){let e=this.config.videoFormat;if(!MediaRecorder.isTypeSupported(e)){const t=["video/webm;codecs=vp9,opus","video/webm;codecs=vp8,opus","video/webm"];for(const i of t)if(MediaRecorder.isTypeSupported(i)){e=i,console.log(`[VideoCapture] Using fallback format: ${i}`);break}}this.mediaRecorder=new MediaRecorder(this.mediaStream,{mimeType:e,videoBitsPerSecond:this.config.videoBitsPerSecond}),this.mediaRecorder.ondataavailable=e=>{e.data&&e.data.size>0&&this.circularBuffer&&this.circularBuffer.add(e.data)},this.mediaRecorder.onstop=()=>{console.log("[Recorder] Stopped")},this.mediaRecorder.onerror=e=>{console.error("[Recorder] Error:",e),this.onError&&this.onError(e.error)},console.log(`[VideoCapture] MediaRecorder created with mimeType: ${e}`)}_startRecording(){console.log(`[VideoCapture] Starting recording (${this.config.groupDuration}ms per group)`);const e=Date.now();this.circularBuffer.startNewGroup(e),this.mediaRecorder.start(100),console.log("[Recorder] Started"),this.restartTimer=setInterval(()=>{this.mediaRecorder&&"recording"===this.mediaRecorder.state&&(console.log(`[VideoCapture] Restarting recorder (every ${this.config.groupDuration}ms)`),this.mediaRecorder.stop(),setTimeout(()=>{if(this.isRunning&&this.mediaRecorder){const e=Date.now();this.circularBuffer.startNewGroup(e),this.mediaRecorder.start(100)}},50))},this.config.groupDuration),this.speechDetector.start(100),console.log(`[Recorder] Auto-restart enabled (interval: ${this.config.groupDuration}ms)`)}_handleSpeakingStart(){console.log("ğŸ—£ï¸ Speaking started"),this.snapshotGroups=this.circularBuffer.getAllGroups(),console.log(`ğŸ“¦ Snapshot ${this.snapshotGroups.length} groups before speaking`),this.onSpeakingStart&&this.onSpeakingStart(),this.isRecording=!0,this.speakingStartTime=Date.now(),this.speakingChunks=[],this.speakingRecorder=new MediaRecorder(this.mediaStream,{mimeType:this.mediaRecorder.mimeType,videoBitsPerSecond:this.config.videoBitsPerSecond}),this.speakingRecorder.ondataavailable=e=>{e.data&&e.data.size>0&&this.speakingChunks.push(e.data)},this.speakingRecorder.start(100),console.log("[SpeakingRecorder] Started"),this.speakingTimeout=setTimeout(()=>{console.warn("âš ï¸ Max speaking duration reached, forcing stop"),this._handleSpeakingEnd()},this.config.maxRecordDuration)}_handleSpeakingEnd(){this.isRecording&&(console.log("ğŸ”‡ Speaking ended"),this.onSpeakingEnd&&this.onSpeakingEnd(),this.speakingTimeout&&(clearTimeout(this.speakingTimeout),this.speakingTimeout=null),"recording"===this.speakingRecorder.state&&this.speakingRecorder.stop(),this.isRecording=!1,setTimeout(()=>{const e=Date.now()-this.speakingStartTime,t=new Blob(this.speakingChunks,{type:this.config.videoFormat});console.log(`ğŸ“¹ Speaking video: ${(e/1e3).toFixed(1)}s, ${(t.size/1024/1024).toFixed(2)} MB, ${this.speakingChunks.length} chunks`);const i=[];for(const e of this.snapshotGroups)i.push({blob:e.blob,duration:e.duration,startTime:e.startTime,endTime:e.endTime,size:e.size,type:"before-speaking"});i.push({blob:t,duration:e,startTime:this.speakingStartTime,endTime:Date.now(),size:t.size,type:"speaking"}),console.log(`âœ… Total video groups: ${i.length} (${this.snapshotGroups.length} before + 1 speaking)`),this.onVideoCapture&&this.onVideoCapture(i),this.circularBuffer&&(this.circularBuffer.clear(),this.circularBuffer.startNewGroup(Date.now()),console.log("ğŸ—‘ï¸ Cleared captured video groups and started new group")),this.snapshotGroups=null,this.speakingChunks=[],this.speakingStartTime=null,this.speakingRecorder=null},200))}getStatus(){return{isRunning:this.isRunning,isRecording:this.isRecording,groupCount:this.circularBuffer?this.circularBuffer.getGroupCount():0,currentEnergy:this.speechDetector?this.speechDetector.getCurrentEnergy():0,threshold:this.config.speechThreshold,isSpeaking:!!this.speechDetector&&this.speechDetector.getSpeakingState()}}getAllVideoGroups(){if(!this.circularBuffer)return[];const e=this.circularBuffer.getAllGroups(),t=this.circularBuffer.getCurrentGroup();return t&&e.push(t),e}destroy(){this.stop(),this.circularBuffer=null,this.speechDetector=null,this.mediaRecorder=null,this.speakingRecorder=null,this.audioAnalyser=null,this.audioContext=null,this.onVideoCapture=null,this.onSpeakingStart=null,this.onSpeakingEnd=null,this.onError=null,console.log("ğŸ—‘ï¸ VideoAutoCaptureManager destroyed")}}class b{constructor(e={}){this.buffer=new Uint8Array(0),this.config={minFileSize:e.minFileSize||1024,maxBufferSize:e.maxBufferSize||10485760,debug:e.debug||!1}}addChunk(e){const t=e instanceof Uint8Array?e:new Uint8Array(e);if(this.buffer.length+t.length>this.config.maxBufferSize)throw new Error(`AudioStreamParser: Buffer overflow (max ${this.config.maxBufferSize} bytes)`);const i=new Uint8Array(this.buffer.length+t.length);i.set(this.buffer,0),i.set(t,this.buffer.length),this.buffer=i,this.config.debug&&console.log(`[AudioStreamParser] Buffer size: ${this.buffer.length} bytes`)}extractComplete(){const e=[];for(;this.buffer.length>=this.config.minFileSize;){const t=this._findNextWavFile();if(!t)break;const{start:i,size:n}=t;if(i+n>this.buffer.length){this.config.debug&&console.log(`[AudioStreamParser] Incomplete file: need ${i+n} bytes, have ${this.buffer.length}`);break}const s=this.buffer.slice(i,i+n);e.push(s.buffer),this.buffer=this.buffer.slice(i+n),this.config.debug&&console.log(`[AudioStreamParser] Extracted complete file: ${n} bytes, remaining buffer: ${this.buffer.length}`)}return e}_findNextWavFile(){for(let e=0;e<=this.buffer.length-8;e++)if(82===this.buffer[e]&&73===this.buffer[e+1]&&70===this.buffer[e+2]&&70===this.buffer[e+3]){const t=8+this._readUint32LE(this.buffer,e+4);if(e+12<=this.buffer.length&&87===this.buffer[e+8]&&65===this.buffer[e+9]&&86===this.buffer[e+10]&&69===this.buffer[e+11])return this.config.debug&&console.log(`[AudioStreamParser] Found WAV file at offset ${e}, size ${t} bytes`),{start:e,size:t}}return null}_readUint32LE(e,t){return e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24}clear(){this.buffer=new Uint8Array(0)}getBufferSize(){return this.buffer.length}finalize(){const e=this.extractComplete();return this.buffer.length>0&&console.warn(`[AudioStreamParser] ${this.buffer.length} bytes remaining in buffer (incomplete file)`),e}}e.AudioStreamParser=b,e.AudioStreamQueue=f,e.DEFAULT_CONFIG=a,e.DigitalHuman=class extends c{constructor(e={}){if(super(),this.config={container:e.container,modelUrl:e.modelUrl||a.DEFAULT_MODEL_URL,useDefaultAnimations:!1!==e.useDefaultAnimations,animations:{idle:e.animations?.idle||null,talking:e.animations?.talking||null},backgroundColor:e.backgroundColor||"#1a1a2e",backgroundImage:void 0!==e.backgroundImage?e.backgroundImage:a.DEFAULT_BACKGROUND_IMAGE,useDefaultBackground:void 0===e.backgroundImage,width:e.width,height:e.height,cameraPosition:e.cameraPosition||a.CAMERA.position,cameraTarget:e.cameraTarget||a.CAMERA.target,autoStart:e.autoStart||null,enableBlinking:!1!==e.enableBlinking,enableSmiling:!1!==e.enableSmiling,enableNodding:!1!==e.enableNodding,enableBrowRaising:!1!==e.enableBrowRaising,enableHeadTilting:!1!==e.enableHeadTilting,expressionFrequency:{...a.EXPRESSION_FREQUENCY,...e.expressionFrequency},onReady:e.onReady||null,onSpeakStart:e.onSpeakStart||null,onSpeakEnd:e.onSpeakEnd||null,onListenStart:e.onListenStart||null,onListenEnd:e.onListenEnd||null,onLoadingStart:e.onLoadingStart||null,onError:e.onError||null,showLoading:!1!==e.showLoading,showControls:e.showControls||!1,enableOrbitControls:!0===e.enableOrbitControls,debug:e.debug||!1},!this.config.container)throw new Error("DigitalHuman: container is required");this.isReady=!1,this.currentMode=null,this.isDestroyed=!1,this.sceneManager=null,this.animationController=null,this.lipSyncEngine=null,this.expressionManager=null,this.audioStreamQueue=null,this.streamAudioContext=null,this.streamAnalyser=null,this.isVideoCallMode=!1,this.localMediaStream=null,this.localVideoElement=null,this.videoCallContainer=null,this.pipContainer=null,this.audioVisualizer=null,this.visualizerAnimationId=null,this.originalContainerStyle=null,this.pipMouseEnterHandler=null,this.pipMouseLeaveHandler=null,this.pipClickHandler=null,this.cameraPipMouseEnterHandler=null,this.cameraPipMouseLeaveHandler=null,this.cameraPipClickHandler=null,this.videoAutoCaptureManager=null,this.isVideoAutoCaptureEnabled=!1,this.avatar=null,this.morphTargetMesh=null,this.headBone=null,this.neckBone=null,this._init()}async _init(){try{const e="string"==typeof this.config.container?document.querySelector(this.config.container):this.config.container;if(!e)throw new Error("Container not found");if(this.config.container=e,this.sceneManager=new r(e,{width:this.config.width,height:this.config.height,backgroundColor:this.config.backgroundColor,backgroundImage:this.config.backgroundImage,cameraPosition:this.config.cameraPosition,cameraTarget:this.config.cameraTarget,enableOrbitControls:this.config.enableOrbitControls}),this.config.showLoading&&this.sceneManager.showLoading(),this.config.onLoadingStart&&this.config.onLoadingStart(),await this._loadModel(),this.animationController=new h(this.avatar,this.sceneManager.mixer),this.sceneManager.mixer=this.animationController.mixer,this.lipSyncEngine=new l(this.morphTargetMesh),this.expressionManager=new d(this.morphTargetMesh,this.headBone,this.neckBone,this.config),await this._loadAnimations(),this.config.backgroundImage)try{await this.setBackgroundImage(this.config.backgroundImage)}catch(e){console.warn("Failed to load background image, using background color instead:",e)}this.isReady=!0,this.config.showLoading&&this.sceneManager.hideLoading(),this.emit("ready"),this.config.onReady&&this.config.onReady(),"listening"===this.config.autoStart?this.startListening():"speaking"===this.config.autoStart&&console.warn('DigitalHuman: autoStart "speaking" requires audio, skipping'),this.config.debug&&console.log("âœ… DigitalHuman initialized")}catch(e){console.error("DigitalHuman initialization failed:",e),this.emit("error",e),this.config.onError&&this.config.onError(e)}}async _loadModel(){return new Promise((e,t)=>{(new i.GLTFLoader).load(this.config.modelUrl,i=>{if(this.avatar=i.scene,this.sceneManager.scene.add(this.avatar),this.avatar.traverse(e=>{if(e.isMesh&&e.morphTargetDictionary&&e.morphTargetInfluences&&(this.morphTargetMesh=e),e.isBone||"Bone"===e.type){const t=e.name.toLowerCase();t.includes("head")&&(this.headBone=e),t.includes("neck")&&(this.neckBone=e)}}),this.morphTargetMesh){if(this.headBone){const e=new o.Vector3(this.config.cameraPosition.x,this.config.cameraPosition.y,this.config.cameraPosition.z);this.headBone.lookAt(e)}e()}else t(new Error("Model does not have morph targets"))},void 0,t)})}async _loadAnimations(){const e={idle:this.config.animations.idle||(this.config.useDefaultAnimations?a.DEFAULT_ANIMATIONS.idle:null),talking:this.config.animations.talking||(this.config.useDefaultAnimations?a.DEFAULT_ANIMATIONS.talking:null)},t=[];e.idle&&t.push(this.animationController.loadAnimation("idle",e.idle)),e.talking&&t.push(this.animationController.loadAnimation("talking",e.talking)),await Promise.all(t)}startListening(){this.isReady?"listening"!==this.currentMode&&("speaking"===this.currentMode&&this.stopSpeaking(),this.currentMode="listening",this.animationController.play("idle"),this.expressionManager.startListeningMode(),this.emit("listenStart"),this.config.onListenStart&&this.config.onListenStart(),this.config.debug&&console.log("ğŸ‘‚ Listening mode started")):console.warn("DigitalHuman: not ready yet")}stopListening(){"listening"===this.currentMode&&(this.currentMode=null,this.animationController.stop("idle"),this.expressionManager.stopListeningMode(),this.emit("listenEnd"),this.config.onListenEnd&&this.config.onListenEnd(),this.config.debug&&console.log("â¹ Listening mode stopped"))}async speak(e){if(!this.isReady)return void console.warn("DigitalHuman: not ready yet");let t;if("listening"===this.currentMode&&this.stopListening(),this.currentMode="speaking",this.animationController.play("talking"),this.expressionManager.startSpeakingMode(),"string"==typeof e)t=new Audio(e);else if(e instanceof Blob)t=new Audio(URL.createObjectURL(e));else{if(!(e instanceof ArrayBuffer))throw new Error("Unsupported audio type");{const i=new Blob([e],{type:"audio/wav"});t=new Audio(URL.createObjectURL(i))}}t.crossOrigin="anonymous",t.addEventListener("play",()=>{this.lipSyncEngine.start(t),this.emit("speakStart",e),this.config.onSpeakStart&&this.config.onSpeakStart(e)}),t.addEventListener("ended",()=>{this.lipSyncEngine.stop(),this.emit("speakEnd"),this.config.onSpeakEnd&&this.config.onSpeakEnd()}),t.addEventListener("error",e=>{console.error("Audio playback error:",e),this.emit("error",e),this.config.onError&&this.config.onError(e)});try{await t.play(),this.config.debug&&console.log("ğŸ—£ï¸ Speaking mode started")}catch(e){throw console.error("Audio play failed:",e),e}return t}stopSpeaking(){"speaking"===this.currentMode&&(this.currentMode=null,this.animationController.stop("talking"),this.lipSyncEngine.stop(),this.expressionManager.stopSpeakingMode(),this.audioStreamQueue&&(this.audioStreamQueue.stop(),this.audioStreamQueue=null),this.config.debug&&console.log("â¹ Speaking mode stopped"))}async speakStreaming(e){if(!this.isReady)return console.warn("DigitalHuman: not ready yet"),null;if(!e||!e.audioStream)throw new Error("audioStream is required for streaming mode");"listening"===this.currentMode&&this.stopListening(),"speaking"===this.currentMode&&this.stopSpeaking(),this.currentMode="speaking",this.animationController.play("talking"),this.expressionManager.startSpeakingMode(),this.streamAudioContext||(this.streamAudioContext=new(window.AudioContext||window.webkitAudioContext),this.streamAnalyser=this.streamAudioContext.createAnalyser(),this.streamAnalyser.fftSize=a.LIP_SYNC.fftSize,this.streamAnalyser.connect(this.streamAudioContext.destination)),"suspended"===this.streamAudioContext.state&&await this.streamAudioContext.resume(),this.audioStreamQueue=new f(this.streamAudioContext,this.streamAnalyser,{autoPCMConvert:!1!==e.autoPCMConvert,sampleRate:e.sampleRate||16e3,numChannels:e.numChannels||1,bitDepth:e.bitDepth||16}),this.audioStreamQueue.onStart=()=>{this.lipSyncEngine.startStreaming(this.streamAnalyser,this.streamAudioContext),this.emit("speakStart",{streaming:!0}),this.config.onSpeakStart&&this.config.onSpeakStart({streaming:!0}),this.config.debug&&console.log("ğŸ—£ï¸ Streaming speaking mode started")},this.audioStreamQueue.onEnd=()=>{this.lipSyncEngine.stop(),this.currentMode=null,this.emit("speakEnd"),this.config.onSpeakEnd&&this.config.onSpeakEnd(),e.onStreamEnd&&e.onStreamEnd(),this.config.debug&&console.log("âœ… Streaming speaking mode ended")},this.audioStreamQueue.onError=e=>{console.error("AudioStreamQueue error:",e),this.emit("error",e),this.config.onError&&this.config.onError(e)};const{audioStream:t}=e;return(async()=>{try{if("function"==typeof t||t[Symbol.asyncIterator]){const i="function"==typeof t?t():t;for await(const t of i){if(!this.audioStreamQueue)break;await this.audioStreamQueue.enqueue(t),e.onChunkReceived&&e.onChunkReceived(t)}}this.audioStreamQueue&&this.audioStreamQueue.finalize()}catch(e){console.error("Error processing audio stream:",e),this.emit("error",e),this.config.onError&&this.config.onError(e)}})(),{stop:()=>{this.stopSpeaking()},isPlaying:()=>"speaking"===this.currentMode,enqueueAudio:async e=>{this.audioStreamQueue&&await this.audioStreamQueue.enqueue(e)}}}setBackgroundColor(e){this.sceneManager.setBackgroundColor(e)}async setBackgroundImage(e){await this.sceneManager.setBackgroundImage(e)}clearBackgroundImage(){this.sceneManager.clearBackgroundImage()}destroy(){this.isDestroyed||(this.stopListening(),this.stopSpeaking(),this.sceneManager&&this.sceneManager.destroy(),this.expressionManager&&this.expressionManager.destroy(),this.lipSyncEngine&&this.lipSyncEngine.destroy(),this.audioStreamQueue&&(this.audioStreamQueue.destroy(),this.audioStreamQueue=null),this.streamAudioContext&&(this.streamAudioContext.close(),this.streamAudioContext=null),this.streamAnalyser=null,this.isVideoCallMode&&this.exitVideoCallMode(),this.isDestroyed=!0,this.removeAllListeners(),this.config.debug&&console.log("ğŸ—‘ï¸ DigitalHuman destroyed"))}async enterVideoCallMode(e={}){if(this.isVideoCallMode)return console.warn("Already in video call mode"),this.localMediaStream;const t={pipPosition:e.pipPosition||"bottom-right",pipScale:e.pipScale||.25,showLocalVideo:!1!==e.showLocalVideo,showAudioVisualizer:!1!==e.showAudioVisualizer};this.currentPipPosition=t.pipPosition,this.currentPipScale=t.pipScale,this.currentShowLocalVideo=t.showLocalVideo,this.currentShowAudioVisualizer=t.showAudioVisualizer;try{return this.localMediaStream=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280},height:{ideal:720},facingMode:"user"},audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),this._createVideoCallLayout(t),t.showLocalVideo&&this.localVideoElement&&(this.localVideoElement.srcObject=this.localMediaStream),t.showAudioVisualizer&&this._startAudioVisualizer(),this.isVideoCallMode=!0,this.emit("videoCallEnter",{stream:this.localMediaStream}),this.config.debug&&console.log("ğŸ“¹ Entered video call mode"),this.localMediaStream}catch(e){throw console.error("Failed to enter video call mode:",e),this.emit("videoCallError",{error:e}),e}}exitVideoCallMode(){this.isVideoCallMode&&(this.isVideoAutoCaptureEnabled&&this.disableVideoAutoCapture(),this.visualizerAnimationId&&(cancelAnimationFrame(this.visualizerAnimationId),this.visualizerAnimationId=null),this.localMediaStream&&(this.localMediaStream.getTracks().forEach(e=>e.stop()),this.localMediaStream=null),this._removeVideoCallLayout(),this.isVideoCallMode=!1,this.emit("videoCallExit"),this.config.debug&&console.log("ğŸ“¹ Exited video call mode"))}_createVideoCallLayout(e){const t=this.config.container;t.style.position="relative";const i=e.pipScale<1,n=1===e.pipScale;i&&(this.videoCallContainer=document.createElement("div"),this.videoCallContainer.className="digital-human-video-call-container",this.videoCallContainer.style.cssText="\n                position: absolute;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: #000;\n                z-index: 1;\n                overflow: hidden;\n            ",this.localVideoElement=document.createElement("video"),this.localVideoElement.autoplay=!0,this.localVideoElement.playsInline=!0,this.localVideoElement.muted=!0,this.localVideoElement.style.cssText="\n                width: 100%;\n                height: 100%;\n                object-fit: cover;\n                transform: scaleX(-1); /* é•œåƒç¿»è½¬ï¼Œæ›´è‡ªç„¶ */\n            ",this.videoCallContainer.appendChild(this.localVideoElement),e.showAudioVisualizer&&(this.audioVisualizer=document.createElement("canvas"),this.audioVisualizer.className="audio-visualizer",this.audioVisualizer.style.cssText="\n                    position: absolute;\n                    bottom: 30px;\n                    left: 50%;\n                    transform: translateX(-50%);\n                    width: 120px;\n                    height: 30px;\n                    z-index: 10;\n                    pointer-events: none;\n                ",this.audioVisualizer.width=120,this.audioVisualizer.height=30,this.videoCallContainer.appendChild(this.audioVisualizer)),t.insertBefore(this.videoCallContainer,t.firstChild));const s=this.sceneManager.renderer.domElement;this.pipContainer=document.createElement("div"),this.pipContainer.className="digital-human-pip-container";const o=t.offsetWidth*e.pipScale,a=t.offsetHeight*e.pipScale,r={"bottom-right":{bottom:"20px",right:"20px"},"bottom-left":{bottom:"20px",left:"20px"},"top-right":{top:"20px",right:"20px"},"top-left":{top:"20px",left:"20px"}},h=r[e.pipPosition]||r["bottom-right"];this.pipContainer.style.cssText=`\n            position: absolute;\n            ${h.top?`top: ${h.top};`:""}\n            ${h.bottom?`bottom: ${h.bottom};`:""}\n            ${h.left?`left: ${h.left};`:""}\n            ${h.right?`right: ${h.right};`:""}\n            width: ${o}px;\n            height: ${a}px;\n            border-radius: 0;\n            overflow: hidden;\n            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);\n            z-index: 100;\n            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);\n            cursor: pointer;\n            border: 3px solid rgba(255, 255, 255, 0.2);\n        `,n&&(this.pipContainer.style.cssText=`\n                position: absolute;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                border: none;\n                box-shadow: none;\n                border-radius: 0;\n                overflow: hidden;\n                z-index: 1;\n                background: ${this.config.backgroundColor||"#1a1a2e"};\n            `,this.cameraPipContainer=document.createElement("div"),this.cameraPipContainer.className="digital-human-camera-pip-container",this.cameraPipContainer.style.cssText=`\n                position: absolute;\n                ${h.top?`top: ${h.top};`:""}\n                ${h.bottom?`bottom: ${h.bottom};`:""}\n                ${h.left?`left: ${h.left};`:""}\n                ${h.right?`right: ${h.right};`:""}\n                width: ${o}px;\n                height: ${a}px;\n                border-radius: 0;\n                overflow: hidden;\n                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);\n                z-index: 200;\n                transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);\n                cursor: pointer;\n                border: 3px solid rgba(255, 255, 255, 0.2);\n            `,this.cameraVideoElement=document.createElement("video"),this.cameraVideoElement.autoplay=!0,this.cameraVideoElement.playsInline=!0,this.cameraVideoElement.muted=!0,this.cameraVideoElement.style.cssText="\n                width: 100%;\n                height: 100%;\n                object-fit: cover;\n                transform: scaleX(-1);\n            ",this.cameraPipContainer.appendChild(this.cameraVideoElement),t.appendChild(this.cameraPipContainer),this.cameraPipMouseEnterHandler=()=>{this.cameraPipContainer.style.transform="scale(1.05)",this.cameraPipContainer.style.borderColor="rgba(255, 255, 255, 0.5)"},this.cameraPipMouseLeaveHandler=()=>{this.cameraPipContainer.style.transform="scale(1)",this.cameraPipContainer.style.borderColor="rgba(255, 255, 255, 0.2)"},this.cameraPipClickHandler=async e=>{e.stopPropagation();try{await this.toggleWindowSize()}catch(e){console.error("Failed to toggle window size on camera click:",e)}},this.cameraPipContainer.addEventListener("mouseenter",this.cameraPipMouseEnterHandler),this.cameraPipContainer.addEventListener("mouseleave",this.cameraPipMouseLeaveHandler),this.cameraPipContainer.addEventListener("click",this.cameraPipClickHandler)),e.pipScale<1&&(this.pipMouseEnterHandler=()=>{this.pipContainer.style.transform="scale(1.05)",this.pipContainer.style.borderColor="rgba(255, 255, 255, 0.5)"},this.pipMouseLeaveHandler=()=>{this.pipContainer.style.transform="scale(1)",this.pipContainer.style.borderColor="rgba(255, 255, 255, 0.2)"},this.pipClickHandler=async e=>{e.stopPropagation();try{await this.toggleWindowSize()}catch(e){console.error("Failed to toggle window size on click:",e)}},this.pipContainer.addEventListener("mouseenter",this.pipMouseEnterHandler),this.pipContainer.addEventListener("mouseleave",this.pipMouseLeaveHandler),this.pipContainer.addEventListener("click",this.pipClickHandler)),this.pipContainer.appendChild(s),s.style.width="100%",s.style.height="100%",t.appendChild(this.pipContainer),this.sceneManager.renderer.setSize(o,a),this.sceneManager.camera.aspect=o/a,this.sceneManager.camera.updateProjectionMatrix()}_removeVideoCallLayout(){const e=this.config.container;this.videoCallContainer&&this.videoCallContainer.parentNode&&(this.videoCallContainer.parentNode.removeChild(this.videoCallContainer),this.videoCallContainer=null),this.cameraPipContainer&&this.cameraPipContainer.parentNode&&(this.cameraPipContainer.parentNode.removeChild(this.cameraPipContainer),this.cameraPipContainer=null);const t=this.sceneManager.renderer.domElement;this.pipContainer&&t&&(e.appendChild(t),t.style.width="100%",t.style.height="100%",this.pipContainer.parentNode&&this.pipContainer.parentNode.removeChild(this.pipContainer),this.pipContainer=null),e.style.position="";const i=e.offsetWidth,n=e.offsetHeight;this.sceneManager.renderer.setSize(i,n),this.sceneManager.camera.aspect=i/n,this.sceneManager.camera.updateProjectionMatrix(),this.localVideoElement=null,this.audioVisualizer=null,this.cameraVideoElement=null}async toggleWindowSize(e={}){if(!this.isVideoCallMode)return void console.warn("Not in video call mode, cannot toggle window size");this.config.container;const t=this.currentPipScale<1;this.config.debug&&console.log("ğŸ“¹ åˆ‡æ¢å‰çŠ¶æ€: "+(t?"æ‘„åƒå¤´ä¸»çª—å£ï¼Œæ•°å­—äººå°çª—å£":"æ•°å­—äººä¸»çª—å£ï¼Œæ‘„åƒå¤´å°çª—å£"));try{const i=e.pipScale||.25,n=e.pipPosition||this.currentPipPosition||"bottom-right";t?await this._toggleToDigitalHumanMain(n,i,e):await this._toggleToCameraMain(n,i,e),this.currentPipScale=t?1:i,this.currentPipPosition=n,this.currentShowLocalVideo=!1!==e.showLocalVideo,this.currentShowAudioVisualizer=!1!==e.showAudioVisualizer,this.emit("windowSizeToggle",{isSmallWindow:this.currentPipScale<1,config:{pipPosition:this.currentPipPosition,pipScale:this.currentPipScale,showLocalVideo:this.currentShowLocalVideo,showAudioVisualizer:this.currentShowAudioVisualizer}}),this.config.debug&&console.log("ğŸ“¹ åˆ‡æ¢åçŠ¶æ€: "+(this.currentPipScale<1?"æ‘„åƒå¤´ä¸»çª—å£ï¼Œæ•°å­—äººå°çª—å£":"æ•°å­—äººä¸»çª—å£ï¼Œæ‘„åƒå¤´å°çª—å£"))}catch(e){throw console.error("Failed to toggle window size:",e),this.emit("windowSizeToggleError",{error:e}),e}}async _toggleToDigitalHumanMain(e,t,i){const n=this.config.container;this.visualizerAnimationId&&(cancelAnimationFrame(this.visualizerAnimationId),this.visualizerAnimationId=null);const s=n.offsetWidth,o=n.offsetHeight,a=s*t,r=o*t,h={"bottom-right":{bottom:20,right:20},"bottom-left":{bottom:20,left:20},"top-right":{top:20,right:20},"top-left":{top:20,left:20}},l=h[e]||h["bottom-right"];let d,c;d=void 0!==l.right?s-l.right-a/2:l.left+a/2,c=void 0!==l.bottom?o-l.bottom-r/2:l.top+r/2;const u=s/2-d,p=o/2-c;this.pipContainer&&this.pipMouseEnterHandler&&(this.pipContainer.removeEventListener("mouseenter",this.pipMouseEnterHandler),this.pipContainer.removeEventListener("mouseleave",this.pipMouseLeaveHandler),this.pipContainer.removeEventListener("click",this.pipClickHandler),this.pipMouseEnterHandler=null,this.pipMouseLeaveHandler=null,this.pipClickHandler=null),this.pipContainer.style.transformOrigin="center center",this.cameraPipContainer=document.createElement("div"),this.cameraPipContainer.className="digital-human-camera-pip-container";const m=h[e]||h["bottom-right"];this.cameraPipContainer.style.cssText=`\n            position: absolute;\n            ${void 0!==m.top?`top: ${m.top}px;`:""}\n            ${void 0!==m.bottom?`bottom: ${m.bottom}px;`:""}\n            ${void 0!==m.left?`left: ${m.left}px;`:""}\n            ${void 0!==m.right?`right: ${m.right}px;`:""}\n            width: ${a}px;\n            height: ${r}px;\n            border-radius: 0;\n            overflow: hidden;\n            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);\n            z-index: 50;\n            opacity: 0;\n            transform: scale(0.8);\n            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);\n            cursor: pointer;\n            border: 3px solid rgba(255, 255, 255, 0.2);\n        `,this.cameraVideoElement=document.createElement("video"),this.cameraVideoElement.autoplay=!0,this.cameraVideoElement.playsInline=!0,this.cameraVideoElement.muted=!0,this.cameraVideoElement.style.cssText="\n            width: 100%;\n            height: 100%;\n            object-fit: cover;\n            transform: scaleX(-1);\n        ",this.cameraVideoElement.srcObject=this.localMediaStream,this.cameraPipContainer.appendChild(this.cameraVideoElement),n.appendChild(this.cameraPipContainer),this.pipContainer.offsetHeight,this.pipContainer.style.zIndex="200",this.pipContainer.style.transition="all 0.5s cubic-bezier(0.4, 0, 0.2, 1)";const g=s/a,f=o/r;this.pipContainer.style.transform=`translate(${u}px, ${p}px) scale(${g}, ${f})`,requestAnimationFrame(()=>{this.cameraPipContainer.style.opacity="1",this.cameraPipContainer.style.transform="scale(1)"}),await new Promise(e=>setTimeout(e,500)),this.videoCallContainer&&this.videoCallContainer.parentNode&&(this.videoCallContainer.parentNode.removeChild(this.videoCallContainer),this.videoCallContainer=null,this.localVideoElement=null),this.pipContainer.style.cssText=`\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            border: none;\n            box-shadow: none;\n            border-radius: 0;\n            overflow: hidden;\n            z-index: 1;\n            cursor: default;\n            background: ${this.config.backgroundColor||"#1a1a2e"};\n        `,this.sceneManager.renderer.setSize(s,o),this.sceneManager.camera.aspect=s/o,this.sceneManager.camera.updateProjectionMatrix(),this.cameraPipContainer.style.zIndex="200",this.cameraPipMouseEnterHandler=()=>{this.cameraPipContainer.style.transform="scale(1.05)",this.cameraPipContainer.style.borderColor="rgba(255, 255, 255, 0.5)"},this.cameraPipMouseLeaveHandler=()=>{this.cameraPipContainer.style.transform="scale(1)",this.cameraPipContainer.style.borderColor="rgba(255, 255, 255, 0.2)"},this.cameraPipClickHandler=async e=>{e.stopPropagation(),await this.toggleWindowSize()},this.cameraPipContainer.addEventListener("mouseenter",this.cameraPipMouseEnterHandler),this.cameraPipContainer.addEventListener("mouseleave",this.cameraPipMouseLeaveHandler),this.cameraPipContainer.addEventListener("click",this.cameraPipClickHandler)}async _toggleToCameraMain(e,t,i){const n=this.config.container,s=n.offsetWidth,o=n.offsetHeight,a=s*t,r=o*t,h={"bottom-right":{bottom:20,right:20},"bottom-left":{bottom:20,left:20},"top-right":{top:20,right:20},"top-left":{top:20,left:20}},l=h[e]||h["bottom-right"];let d,c;this.cameraPipContainer&&this.cameraPipMouseEnterHandler&&(this.cameraPipContainer.removeEventListener("mouseenter",this.cameraPipMouseEnterHandler),this.cameraPipContainer.removeEventListener("mouseleave",this.cameraPipMouseLeaveHandler),this.cameraPipContainer.removeEventListener("click",this.cameraPipClickHandler),this.cameraPipMouseEnterHandler=null,this.cameraPipMouseLeaveHandler=null,this.cameraPipClickHandler=null),d=void 0!==l.right?s-l.right-a/2:l.left+a/2,c=void 0!==l.bottom?o-l.bottom-r/2:l.top+r/2;const u=s/2-d,p=o/2-c,m=h[e]||h["bottom-right"],g=document.createElement("div");g.className="digital-human-pip-temp",g.style.cssText=`\n            position: absolute;\n            ${void 0!==m.top?`top: ${m.top}px;`:""}\n            ${void 0!==m.bottom?`bottom: ${m.bottom}px;`:""}\n            ${void 0!==m.left?`left: ${m.left}px;`:""}\n            ${void 0!==m.right?`right: ${m.right}px;`:""}\n            width: ${a}px;\n            height: ${r}px;\n            border-radius: 0;\n            overflow: hidden;\n            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);\n            z-index: 50;\n            opacity: 0;\n            transform: scale(0.8);\n            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);\n            cursor: pointer;\n            border: 3px solid rgba(255, 255, 255, 0.2);\n        `,n.appendChild(g),this.cameraPipContainer.offsetHeight,this.cameraPipContainer.style.zIndex="200",this.cameraPipContainer.style.transformOrigin="center center",this.cameraPipContainer.style.transition="all 0.5s cubic-bezier(0.4, 0, 0.2, 1)";const f=s/a,C=o/r;this.cameraPipContainer.style.transform=`translate(${u}px, ${p}px) scale(${f}, ${C})`,requestAnimationFrame(()=>{g.style.opacity="1",g.style.transform="scale(1)"}),await new Promise(e=>setTimeout(e,500)),this.cameraPipContainer&&this.cameraPipContainer.parentNode&&(this.cameraPipContainer.parentNode.removeChild(this.cameraPipContainer),this.cameraPipContainer=null,this.cameraVideoElement=null),this.videoCallContainer=document.createElement("div"),this.videoCallContainer.className="digital-human-video-call-container",this.videoCallContainer.style.cssText="\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: #000;\n            z-index: 1;\n            overflow: hidden;\n        ",this.localVideoElement=document.createElement("video"),this.localVideoElement.autoplay=!0,this.localVideoElement.playsInline=!0,this.localVideoElement.muted=!0,this.localVideoElement.style.cssText="\n            width: 100%;\n            height: 100%;\n            object-fit: cover;\n            transform: scaleX(-1);\n        ",this.localVideoElement.srcObject=this.localMediaStream,this.videoCallContainer.appendChild(this.localVideoElement),!1!==i.showAudioVisualizer&&(this.audioVisualizer=document.createElement("canvas"),this.audioVisualizer.className="audio-visualizer",this.audioVisualizer.style.cssText="\n                position: absolute;\n                bottom: 30px;\n                left: 50%;\n                transform: translateX(-50%);\n                width: 120px;\n                height: 30px;\n                z-index: 10;\n                pointer-events: none;\n            ",this.audioVisualizer.width=120,this.audioVisualizer.height=30,this.videoCallContainer.appendChild(this.audioVisualizer)),n.insertBefore(this.videoCallContainer,n.firstChild);const y=this.sceneManager.renderer.domElement;g.appendChild(y),this.pipContainer.parentNode.removeChild(this.pipContainer),this.pipContainer=g,this.pipContainer.className="digital-human-pip-container",this.pipContainer.style.opacity="1",this.pipContainer.style.transform="scale(1)",this.pipContainer.style.zIndex="100",this.sceneManager.renderer.setSize(a,r),this.sceneManager.camera.aspect=a/r,this.sceneManager.camera.updateProjectionMatrix(),this.pipMouseEnterHandler=()=>{this.pipContainer.style.transform="scale(1.05)",this.pipContainer.style.borderColor="rgba(255, 255, 255, 0.5)"},this.pipMouseLeaveHandler=()=>{this.pipContainer.style.transform="scale(1)",this.pipContainer.style.borderColor="rgba(255, 255, 255, 0.2)"},this.pipClickHandler=async e=>{e.stopPropagation(),await this.toggleWindowSize()},this.pipContainer.addEventListener("mouseenter",this.pipMouseEnterHandler),this.pipContainer.addEventListener("mouseleave",this.pipMouseLeaveHandler),this.pipContainer.addEventListener("click",this.pipClickHandler),!1!==i.showAudioVisualizer&&this._startAudioVisualizer()}_startAudioVisualizer(){if(!this.localMediaStream||!this.audioVisualizer)return;const e=new(window.AudioContext||window.webkitAudioContext),t=e.createAnalyser();t.fftSize=512,t.smoothingTimeConstant=.85;e.createMediaStreamSource(this.localMediaStream).connect(t);const i=t.frequencyBinCount,n=new Uint8Array(i),s=this.audioVisualizer,o=s.getContext("2d"),a=s.width,r=s.height;let h=0;const l=(e,t,i,n,s)=>{const o=.5*(i-e),a=.5*(n-t),r=s*s;return(2*t-2*i+o+a)*(s*r)+(-3*t+3*i-2*o-a)*r+o*s+t},d=()=>{this.visualizerAnimationId=requestAnimationFrame(d),t.getByteFrequencyData(n),o.clearRect(0,0,a,r);let e=0;for(let t=0;t<i;t++)e+=n[t];h+=.15*(e/i/255*(r/2)*2.1-h);const c=h;o.beginPath(),o.lineWidth=2.5;const u="true"===s.dataset.recording,p=o.createLinearGradient(0,0,a,0);u?(p.addColorStop(0,"rgba(34, 197, 94, 0.3)"),p.addColorStop(.5,"rgba(22, 163, 74, 0.7)"),p.addColorStop(1,"rgba(34, 197, 94, 0.3)")):(p.addColorStop(0,"rgba(135, 206, 250, 0.3)"),p.addColorStop(.5,"rgba(100, 149, 237, 0.7)"),p.addColorStop(1,"rgba(135, 206, 250, 0.3)")),o.strokeStyle=p,o.lineCap="round",o.lineJoin="round";const m=60,g=a/m,f=r/2,C=[];for(let e=0;e<=m;e++){const t=e*g,s=Math.floor(e/m*i),o=n[s]/255,a=1-2*Math.abs(e/m-.5),r=Math.pow(a,2.5),h=f+Math.sin(e/m*Math.PI*4+Date.now()/300)*c*.7*r+o*c*1.7*r;C.push({x:t,y:h})}o.moveTo(C[0].x,C[0].y);for(let e=0;e<C.length-1;e++){const t=C[Math.max(0,e-1)],i=C[e],n=C[e+1],s=C[Math.min(C.length-1,e+2)],a=10;for(let e=1;e<=a;e++){const r=e/a,h=i.x+(n.x-i.x)*r,d=l(t.y,i.y,n.y,s.y,r);o.lineTo(h,d)}}o.stroke(),o.beginPath(),o.lineWidth=2;const y=o.createLinearGradient(0,0,a,0);y.addColorStop(0,"rgba(173, 216, 230, 0.2)"),y.addColorStop(.5,"rgba(135, 206, 250, 0.5)"),y.addColorStop(1,"rgba(173, 216, 230, 0.2)"),o.strokeStyle=y;const S=[];for(let e=0;e<=m;e++){const t=e*g,s=Math.floor(e/m*i),o=n[s]/255,a=1-2*Math.abs(e/m-.5),r=Math.pow(a,2.5),h=f-Math.sin(e/m*Math.PI*4+Date.now()/200)*c*.6*r-o*c*1.4*r;S.push({x:t,y:h})}o.moveTo(S[0].x,S[0].y);for(let e=0;e<S.length-1;e++){const t=S[Math.max(0,e-1)],i=S[e],n=S[e+1],s=S[Math.min(S.length-1,e+2)],a=10;for(let e=1;e<=a;e++){const r=e/a,h=i.x+(n.x-i.x)*r,d=l(t.y,i.y,n.y,s.y,r);o.lineTo(h,d)}}o.stroke()};d()}async enableVideoAutoCapture(e={}){if(!this.isVideoCallMode){const t=new Error("Video auto capture is only available in video call mode");throw console.error(t.message),e.onError&&e.onError(t),t}if(this.isVideoAutoCaptureEnabled)console.warn("Video auto capture already enabled");else{if(!e.onVideoCapture||"function"!=typeof e.onVideoCapture)throw new Error("onVideoCapture callback is required");try{this.videoAutoCaptureManager=new S(this.localMediaStream,e),await this.videoAutoCaptureManager.start(),this.isVideoAutoCaptureEnabled=!0,this.emit("videoAutoCaptureEnabled"),this.config.debug&&console.log("ğŸ“¹ Video auto capture enabled")}catch(t){throw console.error("Failed to enable video auto capture:",t),this.emit("videoAutoCaptureError",{error:t}),e.onError&&e.onError(t),t}}}disableVideoAutoCapture(){this.isVideoAutoCaptureEnabled?(this.videoAutoCaptureManager&&(this.videoAutoCaptureManager.destroy(),this.videoAutoCaptureManager=null),this.isVideoAutoCaptureEnabled=!1,this.emit("videoAutoCaptureDisabled"),this.config.debug&&console.log("ğŸ“¹ Video auto capture disabled")):console.warn("Video auto capture is not enabled")}getVideoAutoCaptureStatus(){return this.videoAutoCaptureManager?this.videoAutoCaptureManager.getStatus():null}getAllVideoGroups(){return this.videoAutoCaptureManager?this.videoAutoCaptureManager.getAllVideoGroups():[]}},e.PCMToWavConverter=class{constructor(e={}){this.sampleRate=e.sampleRate||16e3,this.numChannels=e.numChannels||1,this.bitDepth=e.bitDepth||16}convert(e){return u(e,{sampleRate:this.sampleRate,numChannels:this.numChannels,bitDepth:this.bitDepth})}convertBatch(e){return e.map(e=>this.convert(e))}},e.isPCM=m,e.parseAudioStream=async function*(e,t={}){const i=new b(t);try{for await(const t of e){i.addChunk(t);const e=i.extractComplete();for(const t of e)yield t}const t=i.finalize();for(const e of t)yield e}finally{i.clear()}},e.pcmToWav=u,e.processAudioData=g});
