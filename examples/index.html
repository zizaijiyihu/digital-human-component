<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Human - æ•°å­—äººç»„ä»¶</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        #container {
            max-width: 1200px;
            width: 100%;
        }
        #avatar {
            width: 800px;
            height: 600px;
            margin: 0 auto;
        }
        #controls {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        h2 {
            color: white;
            margin-bottom: 20px;
            text-align: center;
        }
        .control-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        .section-title {
            color: rgba(255,255,255,0.9);
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        button {
            padding: 12px 24px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        button.recording {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        input[type="text"] {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            width: 300px;
            margin: 5px;
        }
        #status {
            margin-top: 15px;
            padding: 10px;
            color: white;
            font-size: 14px;
            text-align: center;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        /* éŸ³é‡æ¡æ ·å¼ */
        .volume-meter {
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .volume-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
            transition: width 0.1s;
            width: 0%;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="avatar"></div>

        <div id="controls">
            <h2>ğŸ­ æ•°å­—äººæ§åˆ¶é¢æ¿</h2>

            <!-- åŸºç¡€æ§åˆ¶ -->
            <div class="control-section">
                <div class="section-title">åŸºç¡€æ§åˆ¶</div>
                <button id="btnListen">ğŸ‘‚ å¯åŠ¨è†å¬æ¨¡å¼</button>
                <button id="btnStop">â¹ åœæ­¢æ‰€æœ‰</button>
            </div>

            <!-- éŸ³é¢‘æ–‡ä»¶æ’­æ”¾ -->
            <div class="control-section">
                <div class="section-title">éŸ³é¢‘æ–‡ä»¶æ’­æ”¾</div>
                <input type="text" id="audioPath" value="audio/kawa.wav" placeholder="éŸ³é¢‘æ–‡ä»¶è·¯å¾„">
                <button id="btnSpeak">ğŸ—£ï¸ æ’­æ”¾éŸ³é¢‘</button>
            </div>

            <!-- ğŸ†• éº¦å…‹é£å®æ—¶é©±åŠ¨ -->
            <div class="control-section">
                <div class="section-title">ğŸ¤ éº¦å…‹é£å®æ—¶é©±åŠ¨</div>
                <div class="volume-meter" id="volumeMeter">
                    <div class="volume-bar" id="volumeBar"></div>
                </div>
                <button id="btnStartMic">ğŸ¤ å¼€å§‹å½•éŸ³é©±åŠ¨</button>
                <button id="btnStopMic" disabled>â¹ åœæ­¢å½•éŸ³</button>
                <div style="color: rgba(255,255,255,0.7); font-size: 12px; margin-top: 8px;">
                    ğŸ’¡ ç‚¹å‡»"å¼€å§‹å½•éŸ³é©±åŠ¨"åå¯¹ç€éº¦å…‹é£è¯´è¯ï¼Œæ•°å­—äººä¼šå®æ—¶åŒæ­¥ä½ çš„å˜´å½¢
                </div>
            </div>

            <!-- ğŸ†• è§†é¢‘é€šè¯æ¨¡å¼ -->
            <div class="control-section">
                <div class="section-title">ğŸ“¹ è§†é¢‘é€šè¯æ¨¡å¼ï¼ˆæ–°åŠŸèƒ½ï¼‰</div>
                <button id="btnEnterVideoCall">ğŸ“¹ è¿›å…¥è§†é¢‘é€šè¯</button>
                <button id="btnExitVideoCall" disabled>âŒ é€€å‡ºè§†é¢‘é€šè¯</button>
                <div style="color: rgba(255,255,255,0.7); font-size: 12px; margin-top: 8px;">
                    ğŸ’¡ è¿›å…¥åï¼Œæ•°å­—äººç¼©å°åˆ°å³ä¸‹è§’ï¼Œä¸»çª—å£æ˜¾ç¤ºæ‘„åƒå¤´ç”»é¢<br>
                    ğŸ–±ï¸ ç‚¹å‡»å°çª—å£å¯åˆ‡æ¢å¤§å°çª—å£ï¼Œæ”¯æŒéŸ³é¢‘å¯è§†åŒ–ç‰¹æ•ˆ
                </div>
            </div>

            <div id="status">æ­£åœ¨åŠ è½½...</div>
        </div>
    </div>

    <!-- å¼•å…¥ Three.js -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <!-- å¼•å…¥ç»„ä»¶ -->
    <script type="module">
        import { DigitalHuman } from '../src/index.js';

        // ===== å…¨å±€å˜é‡ =====
        let avatar = null;

        // éº¦å…‹é£ç›¸å…³
        let mediaStream = null;
        let audioContext = null;
        let analyser = null;
        let micSource = null;
        let isRecording = false;

        // ===== DOM å…ƒç´  =====
        const btnListen = document.getElementById('btnListen');
        const btnStop = document.getElementById('btnStop');
        const btnSpeak = document.getElementById('btnSpeak');
        const btnStartMic = document.getElementById('btnStartMic');
        const btnStopMic = document.getElementById('btnStopMic');
        const audioPath = document.getElementById('audioPath');
        const statusEl = document.getElementById('status');
        const volumeBar = document.getElementById('volumeBar');

        // ===== å·¥å…·å‡½æ•° =====

        /**
         * æ›´æ–°çŠ¶æ€æ˜¾ç¤º
         */
        function updateStatus(text) {
            statusEl.textContent = text;
        }

        /**
         * æ›´æ–°éŸ³é‡æ˜¾ç¤ºï¼ˆä»…åœ¨å½•éŸ³æ—¶ï¼‰
         */
        function updateVolumeMeter() {
            if (!analyser || !isRecording) return;

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);

            // è®¡ç®—å¹³å‡éŸ³é‡
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            const average = sum / dataArray.length;
            const volume = (average / 255) * 100;

            volumeBar.style.width = volume + '%';

            if (isRecording) {
                requestAnimationFrame(updateVolumeMeter);
            }
        }

        /**
         * æ¸…ç†éº¦å…‹é£èµ„æº
         */
        function cleanupMicrophone() {
            // åœæ­¢åª’ä½“æµ
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }

            // æ–­å¼€éŸ³é¢‘æº
            if (micSource) {
                micSource.disconnect();
                micSource = null;
            }

            // æ³¨æ„ï¼šä¸å…³é—­ audioContextï¼Œä¿æŒå¯ç”¨çŠ¶æ€ä¾›åç»­ä½¿ç”¨
            // audioContext å’Œ analyser è®¾ç½®ä¸º nullï¼Œä½†ä¸è°ƒç”¨ close()
            audioContext = null;
            analyser = null;

            // é‡ç½®çŠ¶æ€
            isRecording = false;
            volumeBar.style.width = '0%';
        }

        // ===== åˆ›å»ºæ•°å­—äººå®ä¾‹ =====

        avatar = new DigitalHuman({
            container: '#avatar',
            autoStart: 'listening',  // è‡ªåŠ¨å¯åŠ¨è†å¬æ¨¡å¼
            debug: true,             // å¼€å¯è°ƒè¯•æ—¥å¿—

            // å›è°ƒå‡½æ•°
            onLoadingStart: () => {
                console.log('å¼€å§‹åŠ è½½æ•°å­—äºº...');
            },

            onReady: () => {
                updateStatus('âœ… åŠ è½½å®Œæˆï¼Œæ•°å­—äººå·²å°±ç»ªï¼');
                console.log('âœ… Digital Human is ready!');
            },

            onSpeakStart: (data) => {
                if (data?.streaming) {
                    updateStatus('ğŸ—£ï¸ æ­£åœ¨è¯´è¯ï¼ˆæµå¼æ¨¡å¼ï¼‰...');
                } else {
                    updateStatus('ğŸ—£ï¸ æ­£åœ¨è¯´è¯...');
                }
            },

            onSpeakEnd: () => {
                updateStatus('âœ… è¯´è¯å®Œæˆ');
                // è‡ªåŠ¨åˆ‡æ¢å›è†å¬æ¨¡å¼
                setTimeout(() => {
                    if (!isRecording) {
                        avatar.startListening();
                    }
                }, 500);
            },

            onListenStart: () => {
                updateStatus('ğŸ‘‚ è†å¬ä¸­...');
            },

            onError: (error) => {
                updateStatus('âŒ é”™è¯¯: ' + error.message);
                console.error('Error:', error);
            }
        });

        // ===== åŸºç¡€æ§åˆ¶äº‹ä»¶ =====

        /**
         * å¯åŠ¨è†å¬æ¨¡å¼
         */
        btnListen.addEventListener('click', () => {
            // å¦‚æœæ­£åœ¨å½•éŸ³ï¼Œå…ˆåœæ­¢
            if (isRecording) {
                btnStopMic.click();
            }
            avatar.startListening();
        });

        /**
         * åœæ­¢æ‰€æœ‰æ¨¡å¼
         */
        btnStop.addEventListener('click', () => {
            // åœæ­¢å½•éŸ³ï¼ˆå¦‚æœæ­£åœ¨å½•éŸ³ï¼‰
            if (isRecording) {
                btnStopMic.click();
            }

            avatar.stopListening();
            avatar.stopSpeaking();
            updateStatus('â¹ å·²åœæ­¢');
        });

        // ===== éŸ³é¢‘æ–‡ä»¶æ’­æ”¾ =====

        /**
         * æ’­æ”¾éŸ³é¢‘æ–‡ä»¶
         */
        btnSpeak.addEventListener('click', async () => {
            const path = audioPath.value.trim();
            if (!path) {
                alert('è¯·è¾“å…¥éŸ³é¢‘æ–‡ä»¶è·¯å¾„');
                return;
            }

            // å¦‚æœæ­£åœ¨å½•éŸ³ï¼Œå…ˆåœæ­¢
            if (isRecording) {
                btnStopMic.click();
            }

            try {
                updateStatus('ğŸ”„ æ­£åœ¨åŠ è½½éŸ³é¢‘...');
                await avatar.speak(path);
            } catch (error) {
                alert('æ’­æ”¾å¤±è´¥: ' + error.message);
                console.error('æ’­æ”¾å¤±è´¥:', error);
            }
        });

        // ===== ğŸ†• éº¦å…‹é£å®æ—¶é©±åŠ¨åŠŸèƒ½ =====

        /**
         * å¼€å§‹éº¦å…‹é£å½•éŸ³é©±åŠ¨
         */
        btnStartMic.addEventListener('click', async () => {
            try {
                btnStartMic.disabled = true;
                updateStatus('ğŸ”„ æ­£åœ¨è¯·æ±‚éº¦å…‹é£æƒé™...');

                // è¯·æ±‚éº¦å…‹é£æƒé™
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,   // å›éŸ³æ¶ˆé™¤
                        noiseSuppression: true,   // é™å™ª
                        autoGainControl: true     // è‡ªåŠ¨å¢ç›Šæ§åˆ¶
                    }
                });

                console.log('âœ… éº¦å…‹é£æƒé™å·²è·å–');

                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡å’Œåˆ†æå™¨
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;

                // è¿æ¥éº¦å…‹é£åˆ°åˆ†æå™¨
                micSource = audioContext.createMediaStreamSource(mediaStream);
                micSource.connect(analyser);
                // æ³¨æ„ï¼šä¸è¿æ¥åˆ° destinationï¼Œé¿å…å›éŸ³

                // åœæ­¢å½“å‰æ¨¡å¼
                avatar.stopListening();
                avatar.stopSpeaking();

                // åˆ‡æ¢åˆ°è¯´è¯æ¨¡å¼ï¼ˆæ’­æ”¾ talking åŠ¨ç”»ï¼‰
                avatar.animationController.play('talking');
                avatar.expressionManager.startSpeakingMode();
                avatar.currentMode = 'speaking';

                // å¯åŠ¨å®æ—¶å”‡å½¢åŒæ­¥
                avatar.lipSyncEngine.startStreaming(analyser, audioContext);

                // æ›´æ–°çŠ¶æ€
                isRecording = true;
                btnStopMic.disabled = false;
                btnStartMic.classList.add('recording');

                updateStatus('ğŸ¤ æ­£åœ¨å½•éŸ³ï¼Œå¯¹ç€éº¦å…‹é£è¯´è¯è¯•è¯•ï¼');
                console.log('âœ… éº¦å…‹é£é©±åŠ¨å·²å¯åŠ¨');

                // å¼€å§‹æ›´æ–°éŸ³é‡æ˜¾ç¤º
                updateVolumeMeter();

            } catch (error) {
                console.error('éº¦å…‹é£è®¿é—®å¤±è´¥:', error);
                updateStatus('âŒ éº¦å…‹é£è®¿é—®å¤±è´¥: ' + error.message);
                btnStartMic.disabled = false;

                // ç‰¹æ®Šå¤„ç†æƒé™æ‹’ç»
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    alert('éº¦å…‹é£æƒé™è¢«æ‹’ç»ã€‚è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸è®¿é—®éº¦å…‹é£ï¼Œç„¶ååˆ·æ–°é¡µé¢é‡è¯•ã€‚');
                } else if (error.name === 'NotFoundError') {
                    alert('æœªæ£€æµ‹åˆ°éº¦å…‹é£è®¾å¤‡ï¼Œè¯·æ£€æŸ¥ä½ çš„éº¦å…‹é£æ˜¯å¦å·²è¿æ¥ã€‚');
                } else {
                    alert('æ— æ³•è®¿é—®éº¦å…‹é£: ' + error.message);
                }
            }
        });

        /**
         * åœæ­¢éº¦å…‹é£å½•éŸ³é©±åŠ¨
         */
        btnStopMic.addEventListener('click', () => {
            // æ¸…ç†éº¦å…‹é£èµ„æº
            cleanupMicrophone();

            // åœæ­¢å”‡å½¢åŒæ­¥
            if (avatar.lipSyncEngine) {
                avatar.lipSyncEngine.stop();
            }

            // åœæ­¢è¯´è¯æ¨¡å¼
            avatar.animationController.stop('talking');
            avatar.expressionManager.stopSpeakingMode();
            avatar.currentMode = null;

            // æ›´æ–° UI
            btnStopMic.disabled = true;
            btnStartMic.disabled = false;
            btnStartMic.classList.remove('recording');

            updateStatus('â¹ å½•éŸ³å·²åœæ­¢');
            console.log('â¹ éº¦å…‹é£é©±åŠ¨å·²åœæ­¢');
        });

        // ===== è§†é¢‘é€šè¯æ¨¡å¼æ§åˆ¶ =====

        const btnEnterVideoCall = document.getElementById('btnEnterVideoCall');
        const btnExitVideoCall = document.getElementById('btnExitVideoCall');

        /**
         * è¿›å…¥è§†é¢‘é€šè¯æ¨¡å¼
         */
        btnEnterVideoCall.addEventListener('click', async () => {
            try {
                updateStatus('ğŸ“¹ æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™...');

                // è¿›å…¥è§†é¢‘é€šè¯æ¨¡å¼
                await avatar.enterVideoCallMode({
                    pipPosition: 'bottom-right',  // å³ä¸‹è§’
                    pipScale: 0.25,                // 1/4 å¤§å°
                    showLocalVideo: true,
                    showAudioVisualizer: true
                });

                // æ›´æ–° UI
                btnEnterVideoCall.disabled = true;
                btnExitVideoCall.disabled = false;

                updateStatus('ğŸ“¹ è§†é¢‘é€šè¯æ¨¡å¼å·²å¼€å¯ï¼æ•°å­—äººåœ¨å³ä¸‹è§’å°çª—å£ä¸­');
                console.log('âœ… è§†é¢‘é€šè¯æ¨¡å¼å·²è¿›å…¥');

            } catch (error) {
                console.error('è¿›å…¥è§†é¢‘é€šè¯æ¨¡å¼å¤±è´¥:', error);
                updateStatus('âŒ è¿›å…¥è§†é¢‘é€šè¯æ¨¡å¼å¤±è´¥: ' + error.message);
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´/éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®');
            }
        });

        /**
         * é€€å‡ºè§†é¢‘é€šè¯æ¨¡å¼
         */
        btnExitVideoCall.addEventListener('click', () => {
            avatar.exitVideoCallMode();

            // æ›´æ–° UI
            btnEnterVideoCall.disabled = false;
            btnExitVideoCall.disabled = true;

            updateStatus('âŒ è§†é¢‘é€šè¯æ¨¡å¼å·²é€€å‡º');
            console.log('â¹ è§†é¢‘é€šè¯æ¨¡å¼å·²é€€å‡º');
        });

        // ===== é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº =====

        window.addEventListener('beforeunload', () => {
            if (isRecording) {
                cleanupMicrophone();
            }
            if (avatar) {
                avatar.destroy();
            }
        });

        // ===== æš´éœ²åˆ°å…¨å±€ï¼Œæ–¹ä¾¿è°ƒè¯• =====

        window.avatar = avatar;
        window.debugInfo = {
            isRecording: () => isRecording,
            hasMediaStream: () => !!mediaStream,
            hasAudioContext: () => !!audioContext
        };
    </script>
</body>
</html>
