<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Human - æ•°å­—äººç»„ä»¶</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        #container {
            max-width: 1200px;
            width: 100%;
        }
        #avatar {
            width: 800px;
            height: 600px;
            margin: 0 auto;
        }
        #controls {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        h2 {
            color: white;
            margin-bottom: 20px;
            text-align: center;
        }
        .control-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        .section-title {
            color: rgba(255,255,255,0.9);
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        button {
            padding: 12px 24px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        button.recording {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        input[type="text"] {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            width: 300px;
            margin: 5px;
        }
        #status {
            margin-top: 15px;
            padding: 10px;
            color: white;
            font-size: 14px;
            text-align: center;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        /* éŸ³é‡æ¡æ ·å¼ */
        .volume-meter {
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .volume-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
            transition: width 0.1s;
            width: 0%;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="avatar"></div>

        <div id="controls">
            <h2>ğŸ­ æ•°å­—äººæ§åˆ¶é¢æ¿</h2>

            <!-- åŸºç¡€æ§åˆ¶ -->
            <div class="control-section">
                <div class="section-title">åŸºç¡€æ§åˆ¶</div>
                <button id="btnListen">ğŸ‘‚ å¯åŠ¨è†å¬æ¨¡å¼</button>
                <button id="btnStop">â¹ åœæ­¢æ‰€æœ‰</button>
            </div>

            <!-- éŸ³é¢‘æ–‡ä»¶æ’­æ”¾ -->
            <div class="control-section">
                <div class="section-title">éŸ³é¢‘æ–‡ä»¶æ’­æ”¾</div>
                <input type="text" id="audioPath" value="audio/kawa.wav" placeholder="éŸ³é¢‘æ–‡ä»¶è·¯å¾„">
                <button id="btnSpeak">ğŸ—£ï¸ æ’­æ”¾éŸ³é¢‘</button>
            </div>

            <!-- ğŸ†• éº¦å…‹é£å®æ—¶é©±åŠ¨ -->
            <div class="control-section">
                <div class="section-title">ğŸ¤ éº¦å…‹é£å®æ—¶é©±åŠ¨</div>
                <div class="volume-meter" id="volumeMeter">
                    <div class="volume-bar" id="volumeBar"></div>
                </div>
                <button id="btnStartMic">ğŸ¤ å¼€å§‹å½•éŸ³é©±åŠ¨</button>
                <button id="btnStopMic" disabled>â¹ åœæ­¢å½•éŸ³</button>
                <div style="color: rgba(255,255,255,0.7); font-size: 12px; margin-top: 8px;">
                    ğŸ’¡ ç‚¹å‡»"å¼€å§‹å½•éŸ³é©±åŠ¨"åå¯¹ç€éº¦å…‹é£è¯´è¯ï¼Œæ•°å­—äººä¼šå®æ—¶åŒæ­¥ä½ çš„å˜´å½¢
                </div>
            </div>

            <!-- ğŸ†• è§†é¢‘é€šè¯æ¨¡å¼ -->
            <div class="control-section">
                <div class="section-title">ğŸ“¹ è§†é¢‘é€šè¯æ¨¡å¼</div>
                <button id="btnEnterVideoCall">ğŸ“¹ è¿›å…¥è§†é¢‘é€šè¯</button>
                <button id="btnExitVideoCall" disabled>âŒ é€€å‡ºè§†é¢‘é€šè¯</button>
                <div style="color: rgba(255,255,255,0.7); font-size: 12px; margin-top: 8px;">
                    ğŸ’¡ è¿›å…¥åï¼Œæ•°å­—äººç¼©å°åˆ°å³ä¸‹è§’ï¼Œä¸»çª—å£æ˜¾ç¤ºæ‘„åƒå¤´ç”»é¢<br>
                    ğŸ–±ï¸ ç‚¹å‡»å°çª—å£å¯åˆ‡æ¢å¤§å°çª—å£ï¼Œæ”¯æŒéŸ³é¢‘å¯è§†åŒ–ç‰¹æ•ˆ
                </div>
            </div>

            <!-- ğŸ†• è§†é¢‘è‡ªåŠ¨é‡‡é›†ï¼ˆåˆ†ç»„å½•åˆ¶ï¼‰ -->
            <div class="control-section">
                <div class="section-title">ğŸ¬ è§†é¢‘è‡ªåŠ¨é‡‡é›†ï¼ˆåˆ†ç»„å½•åˆ¶ï¼‰</div>
                <button id="btnEnableCapture" disabled>ğŸ“¹ å¯åŠ¨è§†é¢‘é‡‡é›†</button>
                <button id="btnDisableCapture" disabled>â¹ åœæ­¢è§†é¢‘é‡‡é›†</button>
                <button id="btnDownloadGroups" disabled>ğŸ’¾ ä¸‹è½½æ‰€æœ‰è§†é¢‘ç»„</button>
                <div style="color: rgba(255,255,255,0.7); font-size: 12px; margin-top: 8px;">
                    ğŸ’¡ å¾ªç¯å½•åˆ¶ 1 ç»„è§†é¢‘ï¼Œæ¯ç»„ 5 ç§’<br>
                    ğŸ¤ è¯´è¯æ—¶è‡ªåŠ¨æ•è·ï¼šè¯´è¯å‰çš„ 1-2 ç»„ + è¯´è¯æœŸé—´çš„ 1 ç»„<br>
                    ğŸ›‘ æ‰“æ–­åŠŸèƒ½ï¼šé»˜è®¤å¯ç”¨ï¼Œç”¨æˆ·è¯´è¯æ—¶è‡ªåŠ¨åœæ­¢æ•°å­—äºº<br>
                    ğŸ“Š é‡‡é›†çŠ¶æ€ï¼š<span id="captureStatus">æœªå¯åŠ¨</span><br>
                    ğŸšï¸ éŸ³é¢‘èƒ½é‡ï¼š<span id="audioEnergy">--</span><br>
                    ğŸ“ åŠ¨æ€é˜ˆå€¼ï¼š[<span id="lowThreshold">--</span>, <span id="highThreshold">--</span>]<br>
                    ğŸ”˜ VAD çŠ¶æ€ï¼š<span id="vadState">--</span>
                </div>
            </div>

            <div id="status">æ­£åœ¨åŠ è½½...</div>
        </div>
    </div>

    <!-- å¼•å…¥ Three.js -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <!-- å¼•å…¥ç»„ä»¶ -->
    <script type="module">
        import { DigitalHuman } from '../src/index.js';

        // ===== å…¨å±€å˜é‡ =====
        let avatar = null;

        // éº¦å…‹é£ç›¸å…³
        let mediaStream = null;
        let audioContext = null;
        let analyser = null;
        let micSource = null;
        let isRecording = false;

        // ===== DOM å…ƒç´  =====
        const btnListen = document.getElementById('btnListen');
        const btnStop = document.getElementById('btnStop');
        const btnSpeak = document.getElementById('btnSpeak');
        const btnStartMic = document.getElementById('btnStartMic');
        const btnStopMic = document.getElementById('btnStopMic');
        const audioPath = document.getElementById('audioPath');
        const statusEl = document.getElementById('status');
        const volumeBar = document.getElementById('volumeBar');

        // ===== å·¥å…·å‡½æ•° =====

        /**
         * æ›´æ–°çŠ¶æ€æ˜¾ç¤º
         */
        function updateStatus(text) {
            statusEl.textContent = text;
        }

        /**
         * æ›´æ–°éŸ³é‡æ˜¾ç¤ºï¼ˆä»…åœ¨å½•éŸ³æ—¶ï¼‰
         */
        function updateVolumeMeter() {
            if (!analyser || !isRecording) return;

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);

            // è®¡ç®—å¹³å‡éŸ³é‡
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            const average = sum / dataArray.length;
            const volume = (average / 255) * 100;

            volumeBar.style.width = volume + '%';

            if (isRecording) {
                requestAnimationFrame(updateVolumeMeter);
            }
        }

        /**
         * æ¸…ç†éº¦å…‹é£èµ„æº
         */
        function cleanupMicrophone() {
            // åœæ­¢åª’ä½“æµ
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }

            // æ–­å¼€éŸ³é¢‘æº
            if (micSource) {
                micSource.disconnect();
                micSource = null;
            }

            // æ³¨æ„ï¼šä¸å…³é—­ audioContextï¼Œä¿æŒå¯ç”¨çŠ¶æ€ä¾›åç»­ä½¿ç”¨
            // audioContext å’Œ analyser è®¾ç½®ä¸º nullï¼Œä½†ä¸è°ƒç”¨ close()
            audioContext = null;
            analyser = null;

            // é‡ç½®çŠ¶æ€
            isRecording = false;
            volumeBar.style.width = '0%';
        }

        // ===== åˆ›å»ºæ•°å­—äººå®ä¾‹ =====

        avatar = new DigitalHuman({
            container: '#avatar',
            autoStart: 'listening',  // è‡ªåŠ¨å¯åŠ¨è†å¬æ¨¡å¼
            debug: true,             // å¼€å¯è°ƒè¯•æ—¥å¿—

            // å›è°ƒå‡½æ•°
            onLoadingStart: () => {
                console.log('å¼€å§‹åŠ è½½æ•°å­—äºº...');
            },

            onReady: () => {
                updateStatus('âœ… åŠ è½½å®Œæˆï¼Œæ•°å­—äººå·²å°±ç»ªï¼');
                console.log('âœ… Digital Human is ready!');
            },

            onSpeakStart: (data) => {
                if (data?.streaming) {
                    updateStatus('ğŸ—£ï¸ æ­£åœ¨è¯´è¯ï¼ˆæµå¼æ¨¡å¼ï¼‰...');
                } else {
                    updateStatus('ğŸ—£ï¸ æ­£åœ¨è¯´è¯...');
                }
            },

            onSpeakEnd: () => {
                updateStatus('âœ… è¯´è¯å®Œæˆ');
                // è‡ªåŠ¨åˆ‡æ¢å›è†å¬æ¨¡å¼
                setTimeout(() => {
                    if (!isRecording) {
                        avatar.startListening();
                    }
                }, 500);
            },

            onListenStart: () => {
                updateStatus('ğŸ‘‚ è†å¬ä¸­...');
            },

            onError: (error) => {
                updateStatus('âŒ é”™è¯¯: ' + error.message);
                console.error('Error:', error);
            }
        });

        // ===== åŸºç¡€æ§åˆ¶äº‹ä»¶ =====

        /**
         * å¯åŠ¨è†å¬æ¨¡å¼
         */
        btnListen.addEventListener('click', () => {
            // å¦‚æœæ­£åœ¨å½•éŸ³ï¼Œå…ˆåœæ­¢
            if (isRecording) {
                btnStopMic.click();
            }
            avatar.startListening();
        });

        /**
         * åœæ­¢æ‰€æœ‰æ¨¡å¼
         */
        btnStop.addEventListener('click', () => {
            // åœæ­¢å½•éŸ³ï¼ˆå¦‚æœæ­£åœ¨å½•éŸ³ï¼‰
            if (isRecording) {
                btnStopMic.click();
            }

            avatar.stopListening();
            avatar.stopSpeaking();
            updateStatus('â¹ å·²åœæ­¢');
        });

        // ===== éŸ³é¢‘æ–‡ä»¶æ’­æ”¾ =====

        /**
         * æ’­æ”¾éŸ³é¢‘æ–‡ä»¶
         */
        btnSpeak.addEventListener('click', async () => {
            const path = audioPath.value.trim();
            if (!path) {
                alert('è¯·è¾“å…¥éŸ³é¢‘æ–‡ä»¶è·¯å¾„');
                return;
            }

            // å¦‚æœæ­£åœ¨å½•éŸ³ï¼Œå…ˆåœæ­¢
            if (isRecording) {
                btnStopMic.click();
            }

            try {
                updateStatus('ğŸ”„ æ­£åœ¨åŠ è½½éŸ³é¢‘...');
                await avatar.speak(path);
            } catch (error) {
                alert('æ’­æ”¾å¤±è´¥: ' + error.message);
                console.error('æ’­æ”¾å¤±è´¥:', error);
            }
        });

        // ===== ğŸ†• éº¦å…‹é£å®æ—¶é©±åŠ¨åŠŸèƒ½ =====

        /**
         * å¼€å§‹éº¦å…‹é£å½•éŸ³é©±åŠ¨
         */
        btnStartMic.addEventListener('click', async () => {
            try {
                btnStartMic.disabled = true;
                updateStatus('ğŸ”„ æ­£åœ¨è¯·æ±‚éº¦å…‹é£æƒé™...');

                // è¯·æ±‚éº¦å…‹é£æƒé™
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,   // å›éŸ³æ¶ˆé™¤
                        noiseSuppression: true,   // é™å™ª
                        autoGainControl: true     // è‡ªåŠ¨å¢ç›Šæ§åˆ¶
                    }
                });

                console.log('âœ… éº¦å…‹é£æƒé™å·²è·å–');

                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡å’Œåˆ†æå™¨
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;

                // è¿æ¥éº¦å…‹é£åˆ°åˆ†æå™¨
                micSource = audioContext.createMediaStreamSource(mediaStream);
                micSource.connect(analyser);
                // æ³¨æ„ï¼šä¸è¿æ¥åˆ° destinationï¼Œé¿å…å›éŸ³

                // åœæ­¢å½“å‰æ¨¡å¼
                avatar.stopListening();
                avatar.stopSpeaking();

                // åˆ‡æ¢åˆ°è¯´è¯æ¨¡å¼ï¼ˆæ’­æ”¾ talking åŠ¨ç”»ï¼‰
                avatar.animationController.play('talking');
                avatar.expressionManager.startSpeakingMode();
                avatar.currentMode = 'speaking';

                // å¯åŠ¨å®æ—¶å”‡å½¢åŒæ­¥
                avatar.lipSyncEngine.startStreaming(analyser, audioContext);

                // æ›´æ–°çŠ¶æ€
                isRecording = true;
                btnStopMic.disabled = false;
                btnStartMic.classList.add('recording');

                updateStatus('ğŸ¤ æ­£åœ¨å½•éŸ³ï¼Œå¯¹ç€éº¦å…‹é£è¯´è¯è¯•è¯•ï¼');
                console.log('âœ… éº¦å…‹é£é©±åŠ¨å·²å¯åŠ¨');

                // å¼€å§‹æ›´æ–°éŸ³é‡æ˜¾ç¤º
                updateVolumeMeter();

            } catch (error) {
                console.error('éº¦å…‹é£è®¿é—®å¤±è´¥:', error);
                updateStatus('âŒ éº¦å…‹é£è®¿é—®å¤±è´¥: ' + error.message);
                btnStartMic.disabled = false;

                // ç‰¹æ®Šå¤„ç†æƒé™æ‹’ç»
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    alert('éº¦å…‹é£æƒé™è¢«æ‹’ç»ã€‚è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸è®¿é—®éº¦å…‹é£ï¼Œç„¶ååˆ·æ–°é¡µé¢é‡è¯•ã€‚');
                } else if (error.name === 'NotFoundError') {
                    alert('æœªæ£€æµ‹åˆ°éº¦å…‹é£è®¾å¤‡ï¼Œè¯·æ£€æŸ¥ä½ çš„éº¦å…‹é£æ˜¯å¦å·²è¿æ¥ã€‚');
                } else {
                    alert('æ— æ³•è®¿é—®éº¦å…‹é£: ' + error.message);
                }
            }
        });

        /**
         * åœæ­¢éº¦å…‹é£å½•éŸ³é©±åŠ¨
         */
        btnStopMic.addEventListener('click', () => {
            // æ¸…ç†éº¦å…‹é£èµ„æº
            cleanupMicrophone();

            // åœæ­¢å”‡å½¢åŒæ­¥
            if (avatar.lipSyncEngine) {
                avatar.lipSyncEngine.stop();
            }

            // åœæ­¢è¯´è¯æ¨¡å¼
            avatar.animationController.stop('talking');
            avatar.expressionManager.stopSpeakingMode();
            avatar.currentMode = null;

            // æ›´æ–° UI
            btnStopMic.disabled = true;
            btnStartMic.disabled = false;
            btnStartMic.classList.remove('recording');

            updateStatus('â¹ å½•éŸ³å·²åœæ­¢');
            console.log('â¹ éº¦å…‹é£é©±åŠ¨å·²åœæ­¢');
        });

        // ===== è§†é¢‘é€šè¯æ¨¡å¼æ§åˆ¶ =====

        const btnEnterVideoCall = document.getElementById('btnEnterVideoCall');
        const btnExitVideoCall = document.getElementById('btnExitVideoCall');

        /**
         * è¿›å…¥è§†é¢‘é€šè¯æ¨¡å¼
         */
        btnEnterVideoCall.addEventListener('click', async () => {
            try {
                updateStatus('ğŸ“¹ æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™...');

                // è¿›å…¥è§†é¢‘é€šè¯æ¨¡å¼
                await avatar.enterVideoCallMode({
                    pipPosition: 'bottom-right',  // å³ä¸‹è§’
                    pipScale: 0.25,                // 1/4 å¤§å°
                    showLocalVideo: true,
                    showAudioVisualizer: true
                });

                // æ›´æ–° UI
                btnEnterVideoCall.disabled = true;
                btnExitVideoCall.disabled = false;

                updateStatus('ğŸ“¹ è§†é¢‘é€šè¯æ¨¡å¼å·²å¼€å¯ï¼æ•°å­—äººåœ¨å³ä¸‹è§’å°çª—å£ä¸­');
                console.log('âœ… è§†é¢‘é€šè¯æ¨¡å¼å·²è¿›å…¥');

            } catch (error) {
                console.error('è¿›å…¥è§†é¢‘é€šè¯æ¨¡å¼å¤±è´¥:', error);
                updateStatus('âŒ è¿›å…¥è§†é¢‘é€šè¯æ¨¡å¼å¤±è´¥: ' + error.message);
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´/éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®');
            }
        });

        /**
         * é€€å‡ºè§†é¢‘é€šè¯æ¨¡å¼
         */
        btnExitVideoCall.addEventListener('click', () => {
            avatar.exitVideoCallMode();

            // æ›´æ–° UI
            btnEnterVideoCall.disabled = false;
            btnExitVideoCall.disabled = true;
            btnEnableCapture.disabled = true;
            btnDisableCapture.disabled = true;

            updateStatus('âŒ è§†é¢‘é€šè¯æ¨¡å¼å·²é€€å‡º');
            console.log('â¹ è§†é¢‘é€šè¯æ¨¡å¼å·²é€€å‡º');
        });

        // ===== è§†é¢‘è‡ªåŠ¨é‡‡é›†åŠŸèƒ½ =====

        const btnEnableCapture = document.getElementById('btnEnableCapture');
        const btnDisableCapture = document.getElementById('btnDisableCapture');
        const btnDownloadGroups = document.getElementById('btnDownloadGroups');
        const captureStatus = document.getElementById('captureStatus');
        const audioEnergy = document.getElementById('audioEnergy');
        const lowThreshold = document.getElementById('lowThreshold');
        const highThreshold = document.getElementById('highThreshold');
        const vadState = document.getElementById('vadState');

        let lastVideoGroups = null;    // ä¿å­˜è§†é¢‘ç»„
        let energyMonitorInterval = null; // èƒ½é‡ç›‘æ§å®šæ—¶å™¨

        /**
         * å¯åŠ¨è§†é¢‘è‡ªåŠ¨é‡‡é›†
         */
        btnEnableCapture.addEventListener('click', async () => {
            try {
                await avatar.enableVideoAutoCapture({
                    maxGroups: 1,                  // ä¿ç•™ 1 ç»„è§†é¢‘
                    groupDuration: 5000,           // æ¯ç»„ 5 ç§’
                    speechThreshold: 30,           // é˜ˆå€¼ 30ï¼ˆé™ä½ä»¥æé«˜çµæ•åº¦ï¼‰
                    silenceDuration: 2000,         // é™éŸ³ 2 ç§’åç»“æŸ
                    minSpeakDuration: 500,         // æœ€å°è¯´è¯æ—¶é•¿ 500ms
                    maxRecordDuration: 300000,     // æœ€å¤§å½•åˆ¶ 5 åˆ†é’Ÿ

                    onVideoCapture: (videoGroups) => {
                        console.log(`ğŸ“¹ æ•è·åˆ° ${videoGroups.length} ä¸ªè§†é¢‘ç»„:`);

                        let totalDuration = 0;
                        let totalSize = 0;

                        videoGroups.forEach((group, index) => {
                            const duration = (group.duration / 1000).toFixed(1);
                            const size = (group.size / 1024 / 1024).toFixed(2);
                            totalDuration += group.duration;
                            totalSize += group.size;

                            console.log(`  [${index + 1}] ${group.type}: ${duration}s, ${size} MB`);
                        });

                        // ä¿å­˜è§†é¢‘ç»„
                        lastVideoGroups = videoGroups;

                        // å¯ç”¨ä¸‹è½½æŒ‰é’®
                        btnDownloadGroups.disabled = false;

                        // æ›´æ–°çŠ¶æ€
                        const avgDuration = (totalDuration / 1000).toFixed(1);
                        const avgSize = (totalSize / 1024 / 1024).toFixed(2);
                        updateStatus(`âœ… æ•è·å®Œæˆï¼š${videoGroups.length} ç»„è§†é¢‘ï¼Œæ€»è®¡ ${avgDuration}s (${avgSize}MB)`);
                    },

                    onSpeakingStart: () => {
                        console.log('ğŸ—£ï¸ æ£€æµ‹åˆ°è¯´è¯å¼€å§‹ - å¼€å§‹å®Œæ•´å½•åˆ¶');
                        captureStatus.textContent = 'ğŸ”´ æ­£åœ¨å½•åˆ¶...';
                        captureStatus.style.color = '#ff4444';

                        // å°†éŸ³é¢‘å¯è§†åŒ–å˜æˆç»¿è‰²
                        if (avatar.audioVisualizer) {
                            avatar.audioVisualizer.dataset.recording = 'true';
                        }
                    },

                    onSpeakingEnd: () => {
                        console.log('ğŸ”‡ æ£€æµ‹åˆ°è¯´è¯ç»“æŸ - åœæ­¢å®Œæ•´å½•åˆ¶');
                        captureStatus.textContent = 'â¸ï¸ å¾…æœºä¸­ï¼ˆå¾ªç¯ç¼“å†²ï¼‰';
                        captureStatus.style.color = '#44ff44';

                        // å°†éŸ³é¢‘å¯è§†åŒ–æ¢å¤è“è‰²
                        if (avatar.audioVisualizer) {
                            avatar.audioVisualizer.dataset.recording = 'false';
                        }
                    },

                    onError: (error) => {
                        console.error('è§†é¢‘é‡‡é›†é”™è¯¯:', error);
                        updateStatus('âŒ è§†é¢‘é‡‡é›†é”™è¯¯: ' + error.message);
                    }
                });

                // æ›´æ–° UI
                btnEnableCapture.disabled = true;
                btnDisableCapture.disabled = false;
                btnDownloadGroups.disabled = false;   // ç«‹å³å¯ç”¨ï¼éšæ—¶ä¸‹è½½è§†é¢‘ç»„
                captureStatus.textContent = 'â¸ï¸ å¾…æœºä¸­ï¼ˆå¾ªç¯å½•åˆ¶ 1 ç»„ï¼‰';
                captureStatus.style.color = '#44ff44';

                // å¯åŠ¨èƒ½é‡ç›‘æ§
                energyMonitorInterval = setInterval(() => {
                    const status = avatar.getVideoAutoCaptureStatus();
                    if (status) {
                        // è·å– SpeechDetector å®ä¾‹
                        const speechDetector = avatar.videoAutoCaptureManager?.speechDetector;

                        // æ˜¾ç¤ºéŸ³é¢‘èƒ½é‡
                        audioEnergy.textContent = status.currentEnergy.toFixed(1);

                        // æ˜¾ç¤ºåŠ¨æ€é˜ˆå€¼
                        if (speechDetector) {
                            const low = speechDetector.getLowThreshold();
                            const high = speechDetector.getHighThreshold();
                            lowThreshold.textContent = low.toFixed(1);
                            highThreshold.textContent = high.toFixed(1);

                            // æ˜¾ç¤º VAD çŠ¶æ€
                            const state = speechDetector.getCurrentState();
                            const stateEmoji = {
                                'IDLE': 'âšª',
                                'PRE_ACTIVE': 'ğŸŸ¡',
                                'SPEAKING': 'ğŸŸ¢'
                            };
                            vadState.textContent = `${stateEmoji[state]} ${state}`;
                            vadState.style.color = state === 'SPEAKING' ? '#44ff44' :
                                                   state === 'PRE_ACTIVE' ? '#ffcc00' :
                                                   'rgba(255,255,255,0.7)';
                        }

                        // æ ¹æ®èƒ½é‡å’Œé˜ˆå€¼æ”¹å˜é¢œè‰²
                        const currentLow = speechDetector ? speechDetector.getLowThreshold() : status.threshold;
                        if (status.currentEnergy > currentLow) {
                            audioEnergy.style.color = '#44ff44'; // ç»¿è‰²ï¼šæ£€æµ‹åˆ°å£°éŸ³
                        } else {
                            audioEnergy.style.color = 'rgba(255,255,255,0.7)'; // ç™½è‰²ï¼šé™éŸ³
                        }
                    }
                }, 100); // æ¯100msæ›´æ–°ä¸€æ¬¡

                updateStatus('âœ… è§†é¢‘è‡ªåŠ¨é‡‡é›†å·²å¯åŠ¨ï¼ˆ1 ç»„ Ã— 5 ç§’ï¼‰');
                console.log('âœ… è§†é¢‘è‡ªåŠ¨é‡‡é›†å·²å¯åŠ¨ï¼š1 ç»„ Ã— 5 ç§’');

            } catch (error) {
                console.error('å¯åŠ¨è§†é¢‘é‡‡é›†å¤±è´¥:', error);
                updateStatus('âŒ å¯åŠ¨è§†é¢‘é‡‡é›†å¤±è´¥: ' + error.message);
                alert('å¯åŠ¨å¤±è´¥: ' + error.message);
            }
        });

        /**
         * åœæ­¢è§†é¢‘è‡ªåŠ¨é‡‡é›†
         */
        btnDisableCapture.addEventListener('click', () => {
            avatar.disableVideoAutoCapture();

            // åœæ­¢èƒ½é‡ç›‘æ§
            if (energyMonitorInterval) {
                clearInterval(energyMonitorInterval);
                energyMonitorInterval = null;
            }

            // æ›´æ–° UI
            btnEnableCapture.disabled = false;
            btnDisableCapture.disabled = true;
            btnDownloadGroups.disabled = true;
            captureStatus.textContent = 'æœªå¯åŠ¨';
            captureStatus.style.color = 'rgba(255,255,255,0.7)';
            audioEnergy.textContent = '--';
            lowThreshold.textContent = '--';
            highThreshold.textContent = '--';
            vadState.textContent = '--';

            updateStatus('â¹ è§†é¢‘è‡ªåŠ¨é‡‡é›†å·²åœæ­¢');
            console.log('â¹ è§†é¢‘è‡ªåŠ¨é‡‡é›†å·²åœæ­¢');
        });

        /**
         * ä¸‹è½½æ‰€æœ‰è§†é¢‘ç»„ï¼ˆéšæ—¶è°ƒç”¨æˆ–è¯´è¯åè°ƒç”¨ï¼‰
         */
        btnDownloadGroups.addEventListener('click', () => {
            // å¦‚æœæœ‰è¯´è¯æ•è·çš„è§†é¢‘ç»„ï¼Œä¼˜å…ˆä½¿ç”¨
            let videoGroups = lastVideoGroups;

            // å¦‚æœæ²¡æœ‰ï¼Œè·å–å½“å‰æ‰€æœ‰è§†é¢‘ç»„
            if (!videoGroups || videoGroups.length === 0) {
                videoGroups = avatar.getAllVideoGroups();
            }

            if (!videoGroups || videoGroups.length === 0) {
                alert('æ²¡æœ‰å¯ç”¨çš„è§†é¢‘ç»„ï¼Œè¯·ç­‰å¾…å‡ ç§’è®©è§†é¢‘ç§¯ç´¯');
                updateStatus('âš ï¸ æ²¡æœ‰å¯ç”¨çš„è§†é¢‘ç»„');
                return;
            }

            console.log(`ğŸ’¾ ä¸‹è½½ ${videoGroups.length} ä¸ªè§†é¢‘ç»„`);

            // ä¸‹è½½æ¯ä¸ªè§†é¢‘ç»„
            videoGroups.forEach((group, index) => {
                const url = URL.createObjectURL(group.blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `video-group-${index + 1}-${group.type || 'normal'}-${Date.now()}.webm`;

                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                const duration = (group.duration / 1000).toFixed(1);
                const size = (group.size / 1024 / 1024).toFixed(2);
                console.log(`  [${index + 1}] ${group.type || 'normal'}: ${duration}s, ${size} MB`);
            });

            updateStatus(`ğŸ’¾ å·²ä¸‹è½½ ${videoGroups.length} ä¸ªè§†é¢‘ç»„`);
        });

        // ç›‘å¬è¿›å…¥è§†é¢‘é€šè¯æ¨¡å¼äº‹ä»¶ï¼Œå¯ç”¨é‡‡é›†æŒ‰é’®
        avatar.on('videoCallEnter', () => {
            btnEnableCapture.disabled = false;
        });

        // ç›‘å¬é€€å‡ºè§†é¢‘é€šè¯æ¨¡å¼äº‹ä»¶ï¼Œç¦ç”¨é‡‡é›†æŒ‰é’®
        avatar.on('videoCallExit', () => {
            btnEnableCapture.disabled = true;
            btnDisableCapture.disabled = true;
            btnDownloadGroups.disabled = true;
            captureStatus.textContent = 'æœªå¯åŠ¨';
            captureStatus.style.color = 'rgba(255,255,255,0.7)';
        });

        // ===== ç›‘å¬æ‰“æ–­äº‹ä»¶ =====

        avatar.on('interrupted', ({ reason }) => {
            console.log('ğŸ›‘ æ•°å­—äººè¢«æ‰“æ–­:', reason);
            updateStatus('ğŸ›‘ æ•°å­—äººè¢«ç”¨æˆ·æ‰“æ–­');

            // 2ç§’åè‡ªåŠ¨æ¢å¤çŠ¶æ€æ˜¾ç¤º
            setTimeout(() => {
                if (!avatar.currentMode) {
                    updateStatus('â¹ å·²åœæ­¢');
                }
            }, 2000);
        });

        // ===== é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº =====

        window.addEventListener('beforeunload', () => {
            if (isRecording) {
                cleanupMicrophone();
            }
            if (avatar) {
                avatar.destroy();
            }
        });

        // ===== æš´éœ²åˆ°å…¨å±€ï¼Œæ–¹ä¾¿è°ƒè¯• =====

        window.avatar = avatar;
        window.debugInfo = {
            isRecording: () => isRecording,
            hasMediaStream: () => !!mediaStream,
            hasAudioContext: () => !!audioContext
        };
    </script>
</body>
</html>
